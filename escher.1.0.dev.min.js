/**
 * almond 0.2.6 Copyright (c) 2011-2012, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */

/**
 * vkBeautify - javascript plugin to pretty-print or minify text in XML, JSON, CSS and SQL formats.
 *
 * Version - 0.99.00.beta
 * Copyright (c) 2012 Vadim Kiryukhin
 * vkiryukhin @ gmail.com
 * http://www.eslinstructor.net/vkbeautify/
 *
 * Dual licensed under the MIT and GPL licenses:
 *   http://www.opensource.org/licenses/mit-license.php
 *   http://www.gnu.org/licenses/gpl.html
 *
 *   Pretty print
 *
 *        vkbeautify.xml(text [,indent_pattern]);
 *        vkbeautify.json(text [,indent_pattern]);
 *        vkbeautify.css(text [,indent_pattern]);
 *        vkbeautify.sql(text [,indent_pattern]);
 *
 *        @text - String; text to beatufy;
 *        @indent_pattern - Integer | String;
 *                Integer:  number of white spaces;
 *                String:   character string to visualize indentation ( can also be a set of white spaces )
 *   Minify
 *
 *        vkbeautify.xmlmin(text [,preserve_comments]);
 *        vkbeautify.jsonmin(text);
 *        vkbeautify.cssmin(text [,preserve_comments]);
 *        vkbeautify.sqlmin(text);
 *
 *        @text - String; text to minify;
 *        @preserve_comments - Bool; [optional];
 *                Set this flag to true to prevent removing comments from @text ( minxml and mincss functions only. )
 *
 *   Examples:
 *        vkbeautify.xml(text); // pretty print XML
 *        vkbeautify.json(text, 4 ); // pretty print JSON
 *        vkbeautify.css(text, '. . . .'); // pretty print CSS
 *        vkbeautify.sql(text, '----'); // pretty print SQL
 *
 *        vkbeautify.xmlmin(text, true);// minify XML, preserve comments
 *        vkbeautify.jsonmin(text);// minify JSON
 *        vkbeautify.cssmin(text);// minify CSS, remove comments ( default )
 *        vkbeautify.sqlmin(text);// minify SQL
 *
 */

/**
 * complete.ly 1.0.0
 * MIT Licensing
 * Copyright (c) 2013 Lorenzo Puccetti
 * 
 * This Software shall be used for doing good things, not bad things.
 * 
**/

(function(e,t){typeof define=="function"&&define.amd?define("escher",t):e.escher=t()})(this,function(){var e,t,n;return function(r){function d(e,t){return h.call(e,t)}function v(e,t){var n,r,i,s,o,u,a,f,c,h,p=t&&t.split("/"),d=l.map,v=d&&d["*"]||{};if(e&&e.charAt(0)===".")if(t){p=p.slice(0,p.length-1),e=p.concat(e.split("/"));for(f=0;f<e.length;f+=1){h=e[f];if(h===".")e.splice(f,1),f-=1;else if(h===".."){if(f===1&&(e[2]===".."||e[0]===".."))break;f>0&&(e.splice(f-1,2),f-=2)}}e=e.join("/")}else e.indexOf("./")===0&&(e=e.substring(2));if((p||v)&&d){n=e.split("/");for(f=n.length;f>0;f-=1){r=n.slice(0,f).join("/");if(p)for(c=p.length;c>0;c-=1){i=d[p.slice(0,c).join("/")];if(i){i=i[r];if(i){s=i,o=f;break}}}if(s)break;!u&&v&&v[r]&&(u=v[r],a=f)}!s&&u&&(s=u,o=a),s&&(n.splice(0,o,s),e=n.join("/"))}return e}function m(e,t){return function(){return s.apply(r,p.call(arguments,0).concat([e,t]))}}function g(e){return function(t){return v(t,e)}}function y(e){return function(t){a[e]=t}}function b(e){if(d(f,e)){var t=f[e];delete f[e],c[e]=!0,i.apply(r,t)}if(!d(a,e)&&!d(c,e))throw new Error("No "+e);return a[e]}function w(e){var t,n=e?e.indexOf("!"):-1;return n>-1&&(t=e.substring(0,n),e=e.substring(n+1,e.length)),[t,e]}function E(e){return function(){return l&&l.config&&l.config[e]||{}}}var i,s,o,u,a={},f={},l={},c={},h=Object.prototype.hasOwnProperty,p=[].slice;o=function(e,t){var n,r=w(e),i=r[0];return e=r[1],i&&(i=v(i,t),n=b(i)),i?n&&n.normalize?e=n.normalize(e,g(t)):e=v(e,t):(e=v(e,t),r=w(e),i=r[0],e=r[1],i&&(n=b(i))),{f:i?i+"!"+e:e,n:e,pr:i,p:n}},u={require:function(e){return m(e)},exports:function(e){var t=a[e];return typeof t!="undefined"?t:a[e]={}},module:function(e){return{id:e,uri:"",exports:a[e],config:E(e)}}},i=function(e,t,n,i){var s,l,h,p,v,g=[],w;i=i||e;if(typeof n=="function"){t=!t.length&&n.length?["require","exports","module"]:t;for(v=0;v<t.length;v+=1){p=o(t[v],i),l=p.f;if(l==="require")g[v]=u.require(e);else if(l==="exports")g[v]=u.exports(e),w=!0;else if(l==="module")s=g[v]=u.module(e);else if(d(a,l)||d(f,l)||d(c,l))g[v]=b(l);else{if(!p.p)throw new Error(e+" missing "+l);p.p.load(p.n,m(i,!0),y(l),{}),g[v]=a[l]}}h=n.apply(a[e],g);if(e)if(s&&s.exports!==r&&s.exports!==a[e])a[e]=s.exports;else if(h!==r||!w)a[e]=h}else e&&(a[e]=n)},e=t=s=function(e,t,n,a,f){return typeof e=="string"?u[e]?u[e](t):b(o(e,t).f):(e.splice||(l=e,t.splice?(e=t,t=n,n=null):e=r),t=t||function(){},typeof n=="function"&&(n=a,a=f),a?i(r,e,t,n):setTimeout(function(){i(r,e,t,n)},4),s)},s.config=function(e){return l=e,l.deps&&s(l.deps,l.callback),s},e._defined=a,n=function(e,t,n){t.splice||(n=t,t=[]),!d(a,e)&&!d(f,e)&&(f[e]=[e,t,n])},n.amd={jQuery:!0}}(),n("../build/almond",function(){}),n("lib/vkbeautify",[],function(){function e(e){var t="    ";if(isNaN(parseInt(e)))t=e;else switch(e){case 1:t=" ";break;case 2:t="  ";break;case 3:t="   ";break;case 4:t="    ";break;case 5:t="     ";break;case 6:t="      ";break;case 7:t="       ";break;case 8:t="        ";break;case 9:t="         ";break;case 10:t="          ";break;case 11:t="           ";break;case 12:t="            "}var n=["\n"];for(ix=0;ix<100;ix++)n.push(n[ix]+t);return n}function t(){this.step="    ",this.shift=e(this.step)}function n(e,t){return t-(e.replace(/\(/g,"").length-e.replace(/\)/g,"").length)}function r(e,t){return e.replace(/\s{1,}/g," ").replace(/ AND /ig,"~::~"+t+t+"AND ").replace(/ BETWEEN /ig,"~::~"+t+"BETWEEN ").replace(/ CASE /ig,"~::~"+t+"CASE ").replace(/ ELSE /ig,"~::~"+t+"ELSE ").replace(/ END /ig,"~::~"+t+"END ").replace(/ FROM /ig,"~::~FROM ").replace(/ GROUP\s{1,}BY/ig,"~::~GROUP BY ").replace(/ HAVING /ig,"~::~HAVING ").replace(/ IN /ig," IN ").replace(/ JOIN /ig,"~::~JOIN ").replace(/ CROSS~::~{1,}JOIN /ig,"~::~CROSS JOIN ").replace(/ INNER~::~{1,}JOIN /ig,"~::~INNER JOIN ").replace(/ LEFT~::~{1,}JOIN /ig,"~::~LEFT JOIN ").replace(/ RIGHT~::~{1,}JOIN /ig,"~::~RIGHT JOIN ").replace(/ ON /ig,"~::~"+t+"ON ").replace(/ OR /ig,"~::~"+t+t+"OR ").replace(/ ORDER\s{1,}BY/ig,"~::~ORDER BY ").replace(/ OVER /ig,"~::~"+t+"OVER ").replace(/\(\s{0,}SELECT /ig,"~::~(SELECT ").replace(/\)\s{0,}SELECT /ig,")~::~SELECT ").replace(/ THEN /ig," THEN~::~"+t+"").replace(/ UNION /ig,"~::~UNION~::~").replace(/ USING /ig,"~::~USING ").replace(/ WHEN /ig,"~::~"+t+"WHEN ").replace(/ WHERE /ig,"~::~WHERE ").replace(/ WITH /ig,"~::~WITH ").replace(/ ALL /ig," ALL ").replace(/ AS /ig," AS ").replace(/ ASC /ig," ASC ").replace(/ DESC /ig," DESC ").replace(/ DISTINCT /ig," DISTINCT ").replace(/ EXISTS /ig," EXISTS ").replace(/ NOT /ig," NOT ").replace(/ NULL /ig," NULL ").replace(/ LIKE /ig," LIKE ").replace(/\s{0,}SELECT /ig,"SELECT ").replace(/\s{0,}UPDATE /ig,"UPDATE ").replace(/ SET /ig," SET ").replace(/~::~{1,}/g,"~::~").split("~::~")}return t.prototype.xml=function(t,n){var r=t.replace(/>\s{0,}</g,"><").replace(/</g,"~::~<").replace(/\s*xmlns\:/g,"~::~xmlns:").replace(/\s*xmlns\=/g,"~::~xmlns=").split("~::~"),i=r.length,s=!1,o=0,u="",a=0,f=n?e(n):this.shift;for(a=0;a<i;a++)if(r[a].search(/<!/)>-1){u+=f[o]+r[a],s=!0;if(r[a].search(/-->/)>-1||r[a].search(/\]>/)>-1||r[a].search(/!DOCTYPE/)>-1)s=!1}else r[a].search(/-->/)>-1||r[a].search(/\]>/)>-1?(u+=r[a],s=!1):/^<\w/.exec(r[a-1])&&/^<\/\w/.exec(r[a])&&/^<[\w:\-\.\,]+/.exec(r[a-1])==/^<\/[\w:\-\.\,]+/.exec(r[a])[0].replace("/","")?(u+=r[a],s||o--):r[a].search(/<\w/)>-1&&r[a].search(/<\//)==-1&&r[a].search(/\/>/)==-1?u=s?u+=r[a]:u+=f[o++]+r[a]:r[a].search(/<\w/)>-1&&r[a].search(/<\//)>-1?u=s?u+=r[a]:u+=f[o]+r[a]:r[a].search(/<\//)>-1?u=s?u+=r[a]:u+=f[--o]+r[a]:r[a].search(/\/>/)>-1?u=s?u+=r[a]:u+=f[o]+r[a]:r[a].search(/<\?/)>-1?u+=f[o]+r[a]:r[a].search(/xmlns\:/)>-1||r[a].search(/xmlns\=/)>-1?u+=f[o]+r[a]:u+=r[a];return u[0]=="\n"?u.slice(1):u},t.prototype.json=function(e,t){var t=t?t:this.step;return typeof JSON=="undefined"?e:typeof e=="string"?JSON.stringify(JSON.parse(e),null,t):typeof e=="object"?JSON.stringify(e,null,t):e},t.prototype.css=function(t,n){var r=t.replace(/\s{1,}/g," ").replace(/\{/g,"{~::~").replace(/\}/g,"~::~}~::~").replace(/\;/g,";~::~").replace(/\/\*/g,"~::~/*").replace(/\*\//g,"*/~::~").replace(/~::~\s{0,}~::~/g,"~::~").split("~::~"),i=r.length,s=0,o="",u=0,a=n?e(n):this.shift;for(u=0;u<i;u++)/\{/.exec(r[u])?o+=a[s++]+r[u]:/\}/.exec(r[u])?o+=a[--s]+r[u]:/\*\\/.exec(r[u])?o+=a[s]+r[u]:o+=a[s]+r[u];return o.replace(/^\n{1,}/,"")},t.prototype.sql=function(t,i){var s=t.replace(/\s{1,}/g," ").replace(/\'/ig,"~::~'").split("~::~"),o=s.length,u=[],a=0,f=this.step,l=!0,c=!1,h=0,p="",d=0,v=i?e(i):this.shift;for(d=0;d<o;d++)d%2?u=u.concat(s[d]):u=u.concat(r(s[d],f));o=u.length;for(d=0;d<o;d++){h=n(u[d],h),/\s{0,}\s{0,}SELECT\s{0,}/.exec(u[d])&&(u[d]=u[d].replace(/\,/g,",\n"+f+f+"")),/\s{0,}\s{0,}SET\s{0,}/.exec(u[d])&&(u[d]=u[d].replace(/\,/g,",\n"+f+f+"")),/\s{0,}\(\s{0,}SELECT\s{0,}/.exec(u[d])?(a++,p+=v[a]+u[d]):/\'/.exec(u[d])?(h<1&&a&&a--,p+=u[d]):(p+=v[a]+u[d],h<1&&a&&a--);var m=0}return p=p.replace(/^\n{1,}/,"").replace(/\n{1,}/g,"\n"),p},t.prototype.xmlmin=function(e,t){var n=t?e:e.replace(/\<![ \r\n\t]*(--([^\-]|[\r\n]|-[^\-])*--[ \r\n\t]*)\>/g,"").replace(/[ \r\n\t]{1,}xmlns/g," xmlns");return n.replace(/>\s{0,}</g,"><")},t.prototype.jsonmin=function(e){return typeof JSON=="undefined"?e:JSON.stringify(JSON.parse(e),null,0)},t.prototype.cssmin=function(e,t){var n=t?e:e.replace(/\/\*([^*]|[\r\n]|(\*+([^*/]|[\r\n])))*\*+\//g,"");return n.replace(/\s{1,}/g," ").replace(/\{\s{1,}/g,"{").replace(/\}\s{1,}/g,"}").replace(/\;\s{1,}/g,";").replace(/\/\*\s{1,}/g,"/*").replace(/\*\/\s{1,}/g,"*/")},t.prototype.sqlmin=function(e){return e.replace(/\s{1,}/g," ").replace(/\s{1,}\(/,"(").replace(/\s{1,}\)/,")")},new t}),n("utils",["lib/vkbeautify"],function(e){function t(e,t){var n=parseFloat(e.style("width"))-t.left-t.right,r=parseFloat(e.style("height"))-t.top-t.bottom;return{width:n,height:r}}function n(e,t){var n=parseFloat(e.attr("width"))-t.left-t.right,r=parseFloat(e.attr("height"))-t.top-t.bottom;return{width:n,height:r}}function r(e,t){if(e===undefined)return t;var n=-1,r=t;for(var i in e){var s=e[i];s===undefined&&(s=null),r[i]=s}return r}function i(e,r,i,s){var o=function(e,n,r){e&&(d3.select("body").style("margin","0").style("padding","0"),n.style("height",window.innerHeight-r.top+"px"),n.style("width",window.innerWidth-r.left+"px"),n.style("margin-left",r.left+"px"),n.style("margin-top",r.top+"px"));var i=t(n,r);return i.svg=n.append("svg").attr("width",i.width).attr("height",i.height).attr("xmlns","http://www.w3.org/2000/svg"),i},u;return r?(u=n(e,i),u.svg=e):e?u=o(s,e,i):u=o(s,d3.select("body").append("div"),i),(u.height<=0||u.width<=0)&&console.warn("Container has invalid height or 			 width. Try setting styles for height 			 and width, or use the 'fill_screen' option."),u}function s(e,r,i,s){function u(e,n,r){e&&(n.style("height",window.innerHeight-r.top+"px"),n.style("width",window.innerWidth-r.left+"px"),n.style("margin-left",r.left+"px"),n.style("margin-top",r.top+"px"));var s=t(n,i);return n.select("svg").attr("height",s.height).attr("width",s.width),s}var o;return r?o=n(e,i):e?o=u(s,e,i):console.warn("No selection"),o}function o(e){var t=e.node();while(t.hasChildNodes())t.removeChild(t.lastChild)}function u(e,t){var n="";return e&&d3.text(e,function(e,r){e&&console.warn(e),n=r,t(n)}),!1}function a(){return"omg yes"}function f(e,t,n,r){function i(e,t){return e.indexOf(t,e.length-t.length)!==-1}if(r){t&&console.warn("File "+t+" overridden by value."),n.call(e,null,r,t);return}if(!t){n.call(e,"No filename",null,t);return}i(t,"json")?d3.json(t,function(e,r){n(e,r,t)}):i(t,"css")?d3.text(t,function(e,r){n(e,r,t)}):n.call(e,"Unrecognized file type",null,t);return}function l(e,t,n){var r=-1,i=t.length,s={};while(++r<t.length){var o=t[r].file;s[o]=t[r].callback,f(e,o,function(t,r,o){s[o].call(e,t,r),--i||n.call(e)},t[r].value)}}function c(e,t,n,i,s){var o=r(s,{padding:{left:0,right:0,top:0,bottom:0},x_is_log:!1,y_is_log:!1,y_ticks:null,x_ticks:null,x_nice:!1,y_nice:!1,x_tick_format:null,y_tick_format:null}),u={};return o.x_is_log?u.x=d3.scale.log():u.x=d3.scale.linear(),u.x.range([o.padding.left,n-o.padding.right]).domain(e),t?(o.y_is_log?u.y=d3.scale.log():u.y=d3.scale.linear(),u.y.range([i-o.padding.bottom,1+o.padding.top]).domain(t)):u.y=null,e?(u.x_axis=d3.svg.axis().scale(u.x).orient("bottom"),o.x_nice&&u.x_axis.nice(),o.x_ticks&&u.x_axis.ticks(o.x_ticks),o.x_tick_format&&u.x_axis.tickFormat(o.x_tick_format)):u.x=null,u.y_axis=d3.svg.axis().scale(u.y).orient("left"),o.y_nice&&u.y_axis.nice(),o.y_ticks&&u.y_axis.ticks(o.y_ticks),o.y_tick_format&&u.y_axis.tickFormat(o.y_tick_format),u}function h(e,t,n,r,i,s,o){var u,a,f,l,c,h,p;return e=="x"?(u="x axis",a=[0,s-o.bottom],f=i,l=-6,p=0,c=0,h=0):e=="y"?(u="y axis",a=[o.left,0],f=0,l=6,p=-90,c=0,h=".71em"):console.warn("Bad axis type"),n.append("g").attr("class",u).attr("transform","translate("+a+")").call(r).append("text").attr("class","label").attr("transform","rotate("+p+")").attr("x",f).attr("y",l).attr("dx",c).attr("dy",h).style("text-anchor","end").text(t)}function p(){var e,t=function(n){if(!(this instanceof t)){e=!0;var r=new t(arguments);return e=!1,r}typeof this.init=="function"&&this.init.apply(this,e?n:arguments)};return t}function d(e,t){e.select("defs").remove();var n=e.append("defs");return n.append("style").attr("type","text/css").text(t),n}function v(e,t,n,r,i){var s=d3.select(e).selectAll(t).data(n);s.enter().call(r),s.call(i),s.exit().remove()}function m(e,t,n,r,i,s){var o=d3.select(e).selectAll(t).data(g(n,r),function(e){return e[r]});o.enter().call(i),o.call(s),o.exit().remove()}function g(e,t){var n=[];for(var r in e){var i=y(e[r]);i[t]=r,n.push(i)}return n}function y(e){if(null==e||"object"!=typeof e)return e;if(e instanceof Array){var t=[];for(var n=0,r=e.length;n<r;n++)t[n]=y(e[n]);return t}if(e instanceof Object){var t={};for(var i in e)e.hasOwnProperty(i)&&(t[i]=y(e[i]));return t}throw new Error("Unable to copy obj! Its type isn't supported.")}function b(e,t){for(var n in t)n in e?console.error("Attribute "+n+" already in object."):e[n]=t[n]}function w(e){var t=[];return e.forEach(function(e){e.forEach(function(e){t.indexOf(e)<0&&t.push(e)})}),t}function E(e,t){return e===null||t===null||e===undefined||t===undefined?null:{x:e.x+t.x,y:e.y+t.y}}function S(e,t){return e===null||t===null||e===undefined||t===undefined?null:{x:e.x-t.x,y:e.y-t.y}}function x(e,t){return{x:e.x*t,y:e.y*t}}function T(e,t){function s(e){return window.btoa(unescape(encodeURIComponent(e)))}var n=document.createElement("a");n.download=t+".json";var r=JSON.stringify(e);n.setAttribute("href-lang","text/json"),n.href="data:image/svg+xml;base64,"+s(r);var i=document.createEvent("MouseEvents");i.initMouseEvent("click",!0,!1,self,0,0,0,0,0,!1,!1,!1,!1,0,null),n.dispatchEvent(i)}function N(e,t,n){window.File&&window.FileReader&&window.FileList&&window.Blob||t.call(n,"The File APIs are not fully supported in this browser.",null);var r=new window.FileReader;r.onload=function(e){var r=JSON.parse(e.target.result);t.call(n,null,r)},r.readAsText(e)}function C(t,n,r){function u(e){return window.btoa(unescape(encodeURIComponent(e)))}var i=document.createElement("a"),s,o;i.download=t+".svg",s=(new XMLSerializer).serializeToString(d3.select(n).node()),r&&(s=e.xml(s)),s='<?xml version="1.0" encoding="utf-8"?>\n             <!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"\n         "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">\n'+s,i.setAttribute("href-lang","image/svg+xml"),i.href="data:image/svg+xml;base64,"+u(s),o=document.createEvent("MouseEvents"),o.initMouseEvent("click",!0,!1,self,0,0,0,0,0,!1,!1,!1,!1,0,null),i.dispatchEvent(o)}function k(e,t,n){var r=function(e){return L(e,t,n)};return e.map(r)}function L(e,t,n){var r=Math.cos(-t)*(e.x-n.x)+Math.sin(-t)*(e.y-n.y)+n.x-e.x,i=-Math.sin(-t)*(e.x-n.x)+Math.cos(-t)*(e.y-n.y)+n.y-e.y;return{x:r,y:i}}function A(e){var t=e[1].x-e[0].x,n=e[1].y-e[0].y;return t==0&&n>=0?Math.PI/2:t==0&&n<0?3*Math.PI/2:t>=0&&n>=0?Math.atan(n/t):t>=0?Math.atan(n/t)+2*Math.PI:Math.atan(n/t)+Math.PI}function O(e){return e*180/Math.PI}function M(e,t){return Math.sqrt(Math.pow(t.y-e.y,2)+Math.pow(t.x-e.x,2))}function _(e,t){t.map(function(n,r){e[r]===undefined&&console.error("Argument is undefined: "+String(t[r]))})}return{set_options:r,setup_svg:i,resize_svg:s,remove_child_nodes:o,load_css:u,load_files:l,load_the_file:f,scale_and_axes:c,add_generic_axis:h,make_class:p,setup_defs:d,draw_an_array:v,draw_an_object:m,make_array:g,clone:y,extend:b,unique_concat:w,c_plus_c:E,c_minus_c:S,c_times_scalar:x,download_json:T,load_json:N,export_svg:C,rotate_coords_recursive:k,rotate_coords:L,get_angle:A,to_degrees:O,distance:M,check_undefined:_}}),n("lib/complete.ly",[],function(){return function(e,t){function h(e){return l===undefined&&(l=document.createElement("span"),l.style.visibility="hidden",l.style.position="fixed",l.style.outline="0",l.style.margin="0",l.style.padding="0",l.style.border="0",l.style.left="0",l.style.whiteSpace="pre",l.style.fontSize=t.fontSize,l.style.fontFamily=t.fontFamily,l.style.fontWeight="normal",document.body.appendChild(l)),l.innerHTML=String(e).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),l.getBoundingClientRect().right}t=t||{},t.fontSize=t.fontSize||"16px",t.fontFamily=t.fontFamily||"sans-serif",t.promptInnerHTML=t.promptInnerHTML||"",t.color=t.color||"#333",t.hintColor=t.hintColor||"#aaa",t.backgroundColor=t.backgroundColor||"#fff",t.dropDownBorderColor=t.dropDownBorderColor||"#aaa",t.dropDownZIndex=t.dropDownZIndex||"100",t.dropDownOnHoverBackgroundColor=t.dropDownOnHoverBackgroundColor||"#ddd";var n=document.createElement("input");n.type="text",n.spellcheck=!1,n.style.fontSize=t.fontSize,n.style.fontFamily=t.fontFamily,n.style.color=t.color,n.style.backgroundColor=t.backgroundColor,n.style.width="100%",n.style.outline="0",n.style.border="0",n.style.margin="0",n.style.padding="0";var r=n.cloneNode();r.disabled="",r.style.position="absolute",r.style.top="0",r.style.left="0",r.style.borderColor="transparent",r.style.boxShadow="none",r.style.color=t.hintColor,n.style.backgroundColor="transparent",n.style.verticalAlign="top",n.style.position="relative";var i=document.createElement("div");i.style.position="relative",i.style.outline="0",i.style.border="0",i.style.margin="0",i.style.padding="0";var s=document.createElement("div");s.style.position="absolute",s.style.outline="0",s.style.margin="0",s.style.padding="0",s.style.border="0",s.style.fontSize=t.fontSize,s.style.fontFamily=t.fontFamily,s.style.color=t.color,s.style.backgroundColor=t.backgroundColor,s.style.top="0",s.style.left="0",s.style.overflow="hidden",s.innerHTML=t.promptInnerHTML,s.style.background="transparent";if(document.body===undefined)throw"document.body is undefined. The library was wired up incorrectly.";document.body.appendChild(s);var o=s.getBoundingClientRect().right;i.appendChild(s),s.style.visibility="visible",s.style.left="-"+o+"px",i.style.marginLeft=o+"px",i.appendChild(r),i.appendChild(n);var u=document.createElement("div");u.style.position="absolute",u.style.visibility="hidden",u.style.outline="0",u.style.margin="0",u.style.padding="0",u.style.textAlign="left",u.style.fontSize=t.fontSize,u.style.fontFamily=t.fontFamily,u.style.backgroundColor=t.backgroundColor,u.style.zIndex=t.dropDownZIndex,u.style.cursor="default",u.style.borderStyle="solid",u.style.borderWidth="1px",u.style.borderColor=t.dropDownBorderColor,u.style.overflowX="hidden",u.style.whiteSpace="pre",u.style.overflowY="scroll";var a=function(e){var n=[],r=0,i=-1,s=function(){this.style.outline="1px solid #ddd"},o=function(){this.style.outline="0"},u=function(){a.hide(),a.onmouseselection(this.__hint)},a={hide:function(){e.style.visibility="hidden"},refresh:function(i,f){e.style.visibility="hidden",r=0,e.innerHTML="";var l=window.innerHeight||document.documentElement.clientHeight,c=e.parentNode.getBoundingClientRect(),h=c.top-6,p=l-c.bottom-6;n=[];for(var d=0;d<f.length;d++){if(f[d].indexOf(i)!==0)continue;var v=document.createElement("div");v.style.color=t.color,v.onmouseover=s,v.onmouseout=o,v.onmousedown=u,v.__hint=f[d],v.innerHTML=i+"<b>"+f[d].substring(i.length)+"</b>",n.push(v),e.appendChild(v)}if(n.length===0)return;if(n.length===1&&i===n[0].__hint)return;if(n.length<2)return;a.highlight(0),h>p*3?(e.style.maxHeight=h+"px",e.style.top="",e.style.bottom="100%"):(e.style.top="100%",e.style.bottom="",e.style.maxHeight=p+"px"),e.style.visibility="visible"},highlight:function(e){i!=-1&&n[i]&&(n[i].style.backgroundColor=t.backgroundColor),n[e].style.backgroundColor=t.dropDownOnHoverBackgroundColor,i=e},move:function(t){return e.style.visibility==="hidden"?"":r+t===-1||r+t===n.length?n[r].__hint:(r+=t,a.highlight(r),n[r].__hint)},onmouseselection:function(){}};return a},f=a(u);f.onmouseselection=function(e){n.value=r.value=c+e,p.onChange(n.value),d=n.value,setTimeout(function(){n.focus()},0)},i.appendChild(u),e.appendChild(i);var l,c,p={onArrowDown:function(){},onArrowUp:function(){},onEnter:function(){},onTab:function(){},onChange:function(){p.repaint()},startFrom:0,options:[],wrapper:i,input:n,hint:r,dropDown:u,prompt:s,setText:function(e){r.value=e,n.value=e},getText:function(){return n.value},hideDropDown:function(){f.hide()},repaint:function(){var e=n.value,t=p.startFrom,i=p.options,s=i.length,o=e.substring(t);c=e.substring(0,t),r.value="";for(var a=0;a<s;a++){var l=i[a];if(l.indexOf(o)===0){r.value=c+l;break}}u.style.left=h(c)+"px",f.refresh(o,p.options)}},d,v=function(e,t){d=e.value;var n=function(){var n=e.value;d!==n&&(d=n,t(n))};e.addEventListener?(e.addEventListener("input",n,!1),e.addEventListener("keyup",n,!1),e.addEventListener("change",n,!1)):(e.attachEvent("oninput",n),e.attachEvent("onkeyup",n),e.attachEvent("onchange",n))};v(n,function(e){p.onChange(e)});var m=function(e){e=e||window.event;var t=e.keyCode;if(t==33)return;if(t==34)return;if(t==27){f.hide(),r.value=n.value,n.focus();return}if(t==39||t==35||t==9){t==9&&(e.preventDefault(),e.stopPropagation(),r.value.length==0&&p.onTab());if(r.value.length>0){f.hide(),n.value=r.value;var i=d!=n.value;d=n.value,i&&p.onChange(n.value)}return}if(t==13){if(r.value.length==0)p.onEnter();else{var s=u.style.visibility=="hidden";f.hide();if(s){r.value=n.value,n.focus(),p.onEnter();return}n.value=r.value;var i=d!=n.value;d=n.value,i&&p.onChange(n.value)}return}if(t==40){var o=f.move(1);o==""&&p.onArrowDown(),r.value=c+o;return}if(t==38){var o=f.move(-1);o==""&&p.onArrowUp(),r.value=c+o,e.preventDefault(),e.stopPropagation();return}r.value=""};return n.addEventListener?n.addEventListener("keydown",m,!1):n.attachEvent("onkeydown",m),p}}),n("draw",["utils"],function(e){function t(e){e.on("mousedown.drag",null),e.on("touchstart.drag",null)}function n(t){e.check_undefined(arguments,["enter_selection"]),t.append("rect").attr("class","membrane")}function r(t,n){e.check_undefined(arguments,["enter_selection","scale"]),t.attr("width",function(e){return n.x_size(e.width)}).attr("height",function(e){return n.y_size(e.height)}).attr("transform",function(e){return"translate("+n.x(e.x)+","+n.y(e.y)+")"}).style("stroke-width",function(e){return n.size(10)}).attr("rx",function(e){return n.x_size(20)}).attr("ry",function(e){return n.x_size(20)})}function i(t){e.check_undefined(arguments,["enter_selection"]);var n=t.append("g").attr("id",function(e){return e.reaction_id}).attr("class","reaction").call(o);return}function s(t,n,r,i,s,o,l,c,h,p,d){e.check_undefined(arguments,["update_selection","scale","drawn_nodes","show_beziers","arrow_displacement","defs","arrowheads","default_reaction_color","has_flux","bezier_drag_behavior","label_drag_behavior"]),t.select(".reaction-label").call(function(e){return u(e,n,h,d)});var v=t.selectAll(".segment-group").data(function(t){return e.make_array(t.segments,"segment_id")},function(e){return e.segment_id});v.enter().call(a),v.call(function(e){return f(e,n,r,i,s,o,l,c,h,p)}),v.exit().remove()}function o(t){e.check_undefined(arguments,["sel"]),t.append("text").attr("class","reaction-label label").style("cursor","default")}function u(n,r,i,s){e.check_undefined(arguments,["sel","scale","has_flux","label_drag_behavior"]);var o=d3.format(".4g");n.text(function(e){var t=e.abbreviation;return e.flux!==null?t+=" ("+o(e.flux)+")":i&&(t+=" (0)"),t}).attr("transform",function(e){return"translate("+r.x(e.label_x)+","+r.y(e.label_y)+")"}).style("font-size",function(e){return String(r.size(30))+"px"}).call(t).call(s)}function a(t){e.check_undefined(arguments,["enter_selection"]);var n=t.append("g").attr("class","segment-group").attr("id",function(e){return e.segment_id});n.append("path").attr("class","segment"),n.append("g").attr("class","beziers")}function f(n,r,i,s,o,u,a,f,l,c){function p(t){e.check_undefined(arguments,["enter_selection"]),t.append("circle").attr("class",function(e){return"bezier bezier"+e.bezier}).style("stroke-width",String(r.size(1))+"px").attr("r",String(r.size(5))+"px").on("mouseover",function(e){d3.select(this).style("stroke-width",String(r.size(3))+"px")}).on("mouseout",function(e){d3.select(this).style("stroke-width",String(r.size(1))+"px")})}function m(n,i,s){e.check_undefined(arguments,["update_selection","show_beziers","drag_behavior"]),n.call(t).call(s),i?n.attr("visibility","visible").attr("transform",function(e){return e.x==null||e.y==null?"":"translate("+r.x(e.x)+","+r.y(e.y)+")"}):n.attr("visibility","hidden")}e.check_undefined(arguments,["update_selection","scale","drawn_nodes","show_beziers","arrow_displacement","defs","arrowheads","default_reaction_color","has_flux","bezier_drag_behavior"]),n.selectAll(".segment").datum(function(){return this.parentNode.__data__}).attr("d",function(e){if(e.from_node_id==null||e.to_node_id==null)return null;var t=i[e.from_node_id],n=i[e.to_node_id],s=e.b1,u=e.b2;return t["node_type"]=="metabolite"&&(t=d(o,t,s,"start")),n["node_type"]=="metabolite"&&(n=d(o,u,n,"end")),e.b1==null||e.b2==null?"M"+r.x(t.x)+","+r.y(t.y)+" "+r.x(n.x)+","+r.y(n.y):"M"+r.x(t.x)+","+r.y(t.y)+"C"+r.x(s.x)+","+r.y(s.y)+" "+r.x(u.x)+","+r.y(u.y)+" "+r.x(n.x)+","+r.y(n.y)}).attr("marker-start",function(e){var t=i[e.from_node_id];if(t.node_type=="metabolite"&&(e.reversibility||t.coefficient>0)){var n=e.flux?r.flux_color(Math.abs(e.flux)):f,s=v(u,a,n,!1);return"url(#"+s+")"}return null}).attr("marker-end",function(e){var t=i[e.to_node_id];if(t.node_type=="metabolite"&&(e.reversibility||t.coefficient>0)){var n=e.flux?r.flux_color(Math.abs(e.flux)):f,s=v(u,a,n,!0);return"url(#"+s+")"}return null}).style("stroke",function(e){return l?e.flux!==null?r.flux_color(Math.abs(e.flux)):r.flux_color(0):f}).style("stroke-width",function(e){return e.flux?r.size(r.flux(Math.abs(e.flux))):r.size(r.flux(1))});var h=n.select(".beziers").selectAll(".bezier").data(function(e){var t=[],n=this.parentNode.parentNode.parentNode.__data__.reaction_id,r=this.parentNode.parentNode.__data__.segment_id;return e.b1!=null&&e.b1.x!=null&&e.b1.y!=null&&t.push({bezier:1,x:e.b1.x,y:e.b1.y,reaction_id:n,segment_id:r}),e.b2!=null&&e.b2.x!=null&&e.b2.y!=null&&t.push({bezier:2,x:e.b2.x,y:e.b2.y,reaction_id:n,segment_id:r}),t},function(e){return e.bezier});h.enter().call(function(e){return p(e)}),h.call(function(e){return m(e,s,c)}),h.exit().remove()}function l(t,n,r,i){e.check_undefined(arguments,["enter_selection","scale","drawn_nodes","drawn_reactions"]);var s=t.append("g").attr("class","node").attr("id",function(e){return e.node_id});s.append("circle").attr("class",function(e){return e.node_type=="metabolite"?"node-circle metabolite-circle":"node-circle"}).style("stroke-width",String(n.size(2))+"px").on("mouseover",function(e){d3.select(this).style("stroke-width",String(n.size(3))+"px")}).on("mouseout",function(e){d3.select(this).style("stroke-width",String(n.size(2))+"px")}),s.filter(function(e){return e.node_type=="metabolite"}).append("text").attr("class","node-label label").style("cursor","default")}function c(n,r,i,s,o,u,a){e.check_undefined(arguments,["update_selection","scale","has_node_data","node_data_style","click_fn","drag_behavior","label_drag_behavior"]);var f=n.select(".node-circle").attr("transform",function(e){return"translate("+r.x(e.x)+","+r.y(e.y)+")"}).attr("r",function(e){return e.node_type=="metabolite"?i&&s.indexOf("Size")!==-1?r.size(r.node_size(e.data!==null?e.data:0)):r.size(e.node_is_primary?15:10):r.size(5)}).style("fill",function(e){if(e.node_type=="metabolite")return i&&s.indexOf("Color")!==-1?r.node_color(e.data!==null?e.data:0):"rgb(224, 134, 91)"}).call(t).call(u).on("click",o);n.select(".node-label").attr("transform",function(e){return"translate("+r.x(e.label_x)+","+r.y(e.label_y)+")"}).style("font-size",function(e){return String(r.size(20))+"px"}).text(function(e){var t=d3.format(".4g"),n=e.bigg_id_compartmentalized;return e.data!==null?n+=" ("+t(e.data)+")":i&&(n+=" (0)"),n}).call(t).call(a)}function h(t){e.check_undefined(arguments,["enter_selection"]),t.append("text").attr("class","text-label label").style("cursor","default").text(function(e){return e.text})}function p(n,r,i,s){e.check_undefined(arguments,["update_selection","scale","label_click","label_drag_behavior"]),n.attr("transform",function(e){return"translate("+r.x(e.x)+","+r.y(e.y)+")"}).on("click",i).call(t).call(s)}function d(t,n,r,i){e.check_undefined(arguments,["reaction_arrow_displacement","start","end","displace"]);var s=t,o=e.distance(n,r),u,a;return(!s||!o)&&console.error("Bad value"),i=="start"?(u=n.x+s*(r.x-n.x)/o,a=n.y+s*(r.y-n.y)/o):i=="end"?(u=r.x-s*(r.x-n.x)/o,a=r.y-s*(r.y-n.y)/o):console.error("bad displace value: "+i),{x:u,y:a}}function v(t,n,r,i){e.check_undefined(arguments,["defs","arrowheads_generated","color","is_end"]);var s=i?"start-":"end-",o=String(r).replace("#",s);if(n.indexOf(o)<0){n.push(o);var u=5,a=5,f,l=u/2,c;i?f=0:f=a,i?c="M0,0 V"+u+" L"+a/2+","+u/2+" Z":c="M"+a+",0 V"+u+" L"+a/2+","+u/2+" Z",t.append("svg:marker").attr("id",o).attr("class","arrowhead").attr("refX",f).attr("refY",l).attr("markerWidth",u).attr("markerHeight",a).attr("orient","auto").append("svg:path").attr("d",c).style("fill",r)}return o}return{create_reaction:i,update_reaction:s,create_node:l,update_node:c,create_text_label:h,update_text_label:p,create_membrane:n,update_membrane:r}}),n("build",["utils"],function(e){function t(t,r,i,o,u,a,f){f=Math.PI/180*f;var l=String(++u.reactions),c={x:o.x,y:o.y},h=300,p=[c,e.c_plus_c(c,{x:h,y:0})],d={x:(p[0].x+p[1].x)/2,y:(p[0].y+p[1].y)/2},v={x:30,y:10},m=20,g={abbreviation:t,reversibility:r.reversibility,metabolites:r.metabolites,label_x:d.x+v.x,label_y:d.y+v.y,name:r.name,segments:{}},y=[],b=[],w=0,E=0,S=!1;for(var x in r.metabolites){var T=r.metabolites[x];if(T.coefficient<0){T.index=w;var N=/C([0-9]+)/.exec(T.formula);o.bigg_id_compartmentalized==T.bigg_id_compartmentalized?y.push([T.index,Infinity]):N&&a.indexOf(T.bigg_id)==-1&&y.push([T.index,parseInt(N[1])]),w++}else{T.index=E;var N=/C([0-9]+)/.exec(T.formula);o.bigg_id_compartmentalized==T.bigg_id_compartmentalized?(b.push([T.index,Infinity]),S=!0):N&&a.indexOf(T.bigg_id)==-1&&b.push([T.index,parseInt(N[1])]),E++}}var C=function(e,t){return t[1]>e[1]?t:e},k=y.reduce(C,[0,0])[0],L=b.reduce(C,[0,0])[0];for(var x in r.metabolites){var T=r.metabolites[x];T.coefficient<0?(T.index==k&&(T.is_primary=!0),T.count=w+1):(T.index==L&&(T.is_primary=!0),T.count=E+1)}var A={},O=[{node_type:"anchor_reactants",dis:{x:m*(S?1:-1),y:0}},{node_type:"center",dis:{x:0,y:0}},{node_type:"anchor_products",dis:{x:m*(S?-1:1),y:0}}],M={};O.map(function(e){var t=String(++u.nodes);A[t]={node_type:e.node_type,x:d.x+e.dis.x,y:d.y+e.dis.y,connected_segments:[]},M[e.node_type]=t});var _=[[M.anchor_reactants,M.center],[M.anchor_products,M.center]];_.map(function(e){var t=e[0],n=e[1],r=String(++u.segments);g.segments[r]={b1:null,b2:null,from_node_id:t,to_node_id:n},A[t].connected_segments.push({segment_id:r,reaction_id:l}),A[n].connected_segments.push({segment_id:r,reaction_id:l})});var D=A;for(var x in r.metabolites){T=r.metabolites[x];var P,H;T.coefficient<0?(P=k,H=M.anchor_reactants):(P=L,H=M.anchor_products);var B=s(T,P,p,d,h,S);if(T.bigg_id_compartmentalized==o.bigg_id_compartmentalized){var j=String(++u.segments);g.segments[j]={from_node_id:H,to_node_id:i,b1:B.b1,b2:B.b2},o.connected_segments.push({segment_id:j,reaction_id:l}),D[H].connected_segments.push({segment_id:j,reaction_id:l})}else{var j=String(++u.segments),F=String(++u.nodes);g.segments[j]={from_node_id:H,to_node_id:F,b1:B.b1,b2:B.b2},D[F]={connected_segments:[{segment_id:j,reaction_id:l}],x:B.circle.x,y:B.circle.y,node_is_primary:T.is_primary,compartment_id:T.compartment_id,label_x:B.circle.x+v.x,label_y:B.circle.y+v.y,metabolite_name:T.name,bigg_id:T.bigg_id,bigg_id_compartmentalized:T.bigg_id_compartmentalized,coefficient:T.coefficient,node_type:"metabolite"},D[H].connected_segments.push({segment_id:j,reaction_id:l})}}for(var I in g.segments)g.segments[I].reversibility=g.reversibility;var q={};q[l]=g,D[i]=o;var R=n(D,q,f,c);return{new_reactions:q,new_nodes:D}}function n(t,n,r,s){var o=function(t){return t===null?null:e.rotate_coords(t,r,s)},u=[],a=[];for(var f in t){var l=t[f],c=o({x:l.x,y:l.y}),h=i(l,n,c);l.connected_segments.map(function(t){var r=n[t.reaction_id];if(r===undefined)return;var i=r.segments[t.segment_id];if(i.to_node_id==f&&i.b2){var s=o(i.b2);i.b2=e.c_plus_c(i.b2,s)}else if(i.from_node_id==f&&i.b1){var s=o(i.b1);i.b1=e.c_plus_c(i.b1,s)}}),a=e.unique_concat([a,h.reaction_ids]),u.push(f)}return{node_ids:u,reaction_ids:a}}function r(t,n,r,s){var o=i(t,r,s);return t.connected_segments.map(function(t){var i=r[t.reaction_id];if(i===undefined)return;var u=i.segments[t.segment_id];u.from_node_id==n&&u.b1&&(u.b1=e.c_plus_c(u.b1,s)),u.to_node_id==n&&u.b2&&(u.b2=e.c_plus_c(u.b2,s)),o.reaction_ids.indexOf(t.reaction_id)<0&&o.reaction_ids.push(t.reaction_id)}),o}function i(e,t,n){e.x=e.x+n.x,e.y=e.y+n.y,e.label_x=e.label_x+n.x,e.label_y=e.label_y+n.y;var r=[];return e.connected_segments.map(function(i){var s=t[i.reaction_id];r.indexOf(i.reaction_id)<0&&(r.push(i.reaction_id),e.node_type=="center"&&(s.label_x=s.label_x+n.x,s.label_y=s.label_y+n.y))}),{reaction_ids:r}}function s(t,n,r,i,s,o){var u=r[0],r=[e.c_minus_c(r[0],u),e.c_minus_c(r[1],u)],i=e.c_minus_c(i,u),a=80,f=.4,l=.25,c=a*.7,h=40,p=Math.min(2,t.count-1),d,v,m;t.is_primary?d=20:(d=10,t.index>n?v=t.index-1:v=t.index);var g=s-d,y=[{x:d,y:0},{x:g,y:0}],b,w,E,S;t.coefficient<0!=o&&t.is_primary?(b={x:y[0].x,y:y[0].y},E={x:i.x*(1-f)+y[0].x*f,y:i.y*(1-f)+y[0].y*f},S={x:i.x*l+b.x*(1-l),y:i.y*l+b.y*(1-l)},w={x:r[0].x,y:r[0].y}):t.coefficient<0!=o?(b={x:y[0].x+h,y:y[0].y+(c*v-c*(p-1)/2)},E={x:i.x*(1-f)+y[0].x*f,y:i.y*(1-f)+y[0].y*f},S={x:i.x*l+b.x*(1-l),y:i.y*l+b.y*(1-l)},w={x:r[0].x+h,y:r[0].y+(a*v-a*(p-1)/2)}):t.coefficient>0!=o&&t.is_primary?(b={x:y[1].x,y:y[1].y},E={x:i.x*(1-f)+y[1].x*f,y:i.y*(1-f)+y[1].y*f},S={x:i.x*l+b.x*(1-l),y:i.y*l+b.y*(1-l)},w={x:r[1].x,y:r[1].y}):t.coefficient>0!=o&&(b={x:y[1].x-h,y:y[1].y+(c*v-c*(p-1)/2)},E={x:i.x*(1-f)+y[1].x*f,y:i.y*(1-f)+y[1].y*f},S={x:i.x*l+b.x*(1-l),y:i.y*l+b.y*(1-l)},w={x:r[1].x-h,y:r[1].y+(a*v-a*(p-1)/2)});var x={};return x.b1=e.c_plus_c(u,E),x.b2=e.c_plus_c(u,S),x.circle=e.c_plus_c(u,w),x}return{new_reaction:t,rotate_nodes:n,move_node_and_dependents:r}}),n("Behavior",["utils","build"],function(e,t){function r(e,t){this.map=e,this.undo_stack=t,this.empty_behavior=function(){},this.node_click=null,this.node_drag=this.empty_behavior,this.bezier_drag=this.empty_behavior,this.reaction_label_drag=this.empty_behavior,this.node_label_drag=this.empty_behavior,this.text_label_click=null,this.text_label_drag=this.empty_behavior,this.turn_everything_on()}function i(){this.toggle_node_click(!0),this.toggle_node_drag(!0),this.toggle_text_label_click(!0),this.toggle_label_drag(!0)}function s(){this.toggle_node_click(!1),this.toggle_node_drag(!1),this.toggle_text_label_click(!1),this.toggle_label_drag(!1)}function o(e){e===undefined&&(e=this.node_click==null);if(e){var t=this.map;this.node_click=function(e){t.select_metabolite(this,e),d3.event.stopPropagation()}}else this.node_click=null}function u(e){e===undefined&&(e=this.text_label_click==null);if(e){var t=this.map;this.text_label_click=function(e){t.select_text_label(this,e),d3.event.stopPropagation()}}else this.text_label_click=null}function a(e){e===undefined&&(e=this.node_drag===this.empty_behavior),e?(this.node_drag=this.get_node_drag(this.map,this.undo_stack),this.bezier_drag=this.get_bezier_drag(this.map,this.undo_stack)):this.node_drag=this.empty_behavior}function f(e){e===undefined&&(e=this.label_drag===this.empty_behavior),e?(this.reaction_label_drag=this.get_reaction_label_drag(this.map,this.scale),this.node_label_drag=this.get_node_label_drag(this.map,this.scale),this.text_label_drag=this.get_text_label_drag(this.map,this.scale)):(this.reaction_label_drag=this.empty_behavior,this.node_label_drag=this.empty_behavior,this.text_label_drag=this.empty_behavior)}function l(n,r){function f(t,r){var i=n.nodes[r],s=n.nodes[t],o=[];i.connected_segments.forEach(function(i){var u=n.reactions[i.reaction_id].segments[i.segment_id];if(u.from_node_id==r)u.from_node_id=t;else{if(u.to_node_id!=r)return console.error("Segment does not connect to dragged node");u.to_node_id=t}s.connected_segments.push(i),o.push(e.clone(i))});var u={};return u[r]=i,n.delete_node_data(u),d3.selectAll(".node-to-combine").classed("node-to-combine",!1),n.draw_everything(),o}var i=d3.behavior.drag(),s=null,o=null,u=null,a=null;return i.on("dragstart",function(){var e=this.parentNode.__data__,t=e.bigg_id_compartmentalized,r=this.parentNode;d3.event.sourceEvent.stopPropagation(),s={},a=window.setTimeout(function(){r.parentNode.insertBefore(r,r.parentNode.firstChild)},200),d3.selectAll(".metabolite-circle").on("mouseover.combine",function(r){r.bigg_id_compartmentalized==t&&r.node_id!=e.node_id&&d3.select(this).style("stroke-width",String(n.scale.size(12))+"px").classed("node-to-combine",!0)}).on("mouseout.combine",function(e){e.bigg_id_compartmentalized==t&&d3.selectAll(".node-to-combine").style("stroke-width",String(n.scale.size(2))+"px").classed("node-to-combine",!1)})}),i.on("drag",function(){var r=this.parentNode.__data__.node_id,i=n.get_selected_node_ids();o=[],i.indexOf(r)==-1?o.push(r):o=i,u=[],o.forEach(function(r){var i=n.nodes[r],o={x:n.scale.x_size.invert(d3.event.dx),y:n.scale.y_size.invert(d3.event.dy)},a=t.move_node_and_dependents(i,r,n.reactions,o);u=e.unique_concat([u,a.reaction_ids]),r in s||(s[r]={x:0,y:0}),s[r]=e.c_plus_c(s[r],o)}),n.draw_these_nodes(o),n.draw_these_reactions(u)}),i.on("dragend",function(){if(o===null){s=null,o=null,u=null,a=null;return}var i=[];d3.selectAll(".node-to-combine").each(function(e){i.push(e.node_id)});if(i.length==1){var l=i[0],c=this.parentNode.__data__.node_id,h=e.clone(n.nodes[c]),p=f(l,c);r.push(function(){n.nodes[c]=h;var e=n.nodes[l],t=[];p.forEach(function(r){var i=n.reactions[r.reaction_id].segments[r.segment_id];i.from_node_id==l?i.from_node_id=c:i.to_node_id==l?i.to_node_id=c:console.error("Segment does not connect to fixed node"),e.connected_segments=e.connected_segments.filter(function(e){return e.reaction_id!=r.reaction_id||e.segment_id!=r.segment_id}),t.indexOf(r.reaction_id)==-1&&t.push(r.reaction_id)}),n.draw_these_nodes([c]),n.draw_these_reactions(t)},function(){f(l,c)})}else{var d=e.clone(s),v=e.clone(o),m=e.clone(u);r.push(function(){v.forEach(function(r){var i=n.nodes[r];t.move_node_and_dependents(i,r,n.reactions,e.c_times_scalar(d[r],-1))}),n.draw_these_nodes(v),n.draw_these_reactions(m)},function(){v.forEach(function(e){var r=n.nodes[e];t.move_node_and_dependents(r,e,n.reactions,d[e])}),n.draw_these_nodes(v),n.draw_these_reactions(m)})}d3.selectAll(".metabolite-circle").on("mouseover.combine",null).on("mouseout.combine",null),window.clearTimeout(a),s=null,o=null,u=null,a=null}),i}function c(t,n){var r=function(n,r,i,s){var o=t.reactions[n].segments[r];o["b"+i]=e.c_plus_c(o["b"+i],s)},i=function(e){},s=function(e,n,i){r(e.reaction_id,e.segment_id,e.bezier,n),t.draw_these_reactions([e.reaction_id])},o=function(e){},u=function(n,i){r(n.reaction_id,n.segment_id,n.bezier,e.c_times_scalar(i,-1)),t.draw_these_reactions([n.reaction_id])},a=function(e,n){r(e.reaction_id,e.segment_id,e.bezier,n),t.draw_these_reactions([e.reaction_id])};return this.get_generic_drag(i,s,o,u,a)}function h(t,n){var r=function(e,n){var r=t.reactions[e];r.label_x=r.label_x+n.x,r.label_y=r.label_y+n.y},i=function(e){},s=function(e,n,i){r(e.reaction_id,n),t.draw_these_reactions([e.reaction_id])},o=function(e){},u=function(n,i){r(n.reaction_id,e.c_times_scalar(i,-1)),t.draw_these_reactions([n.reaction_id])},a=function(e,n){r(e.reaction_id,n),t.draw_these_reactions([e.reaction_id])};return this.get_generic_drag(i,s,o,u,a)}function p(t,n){var r=function(e,n){var r=t.nodes[e];r.label_x=r.label_x+n.x,r.label_y=r.label_y+n.y},i=function(e){},s=function(e,n,i){r(e.node_id,n),t.draw_these_nodes([e.node_id])},o=function(e){},u=function(n,i){r(n.node_id,e.c_times_scalar(i,-1)),t.draw_these_nodes([n.node_id])},a=function(e,n){r(e.node_id,n),t.draw_these_nodes([e.node_id])};return this.get_generic_drag(i,s,o,u,a)}function d(t,n){var r=function(e,n){var r=t.text_labels[e];r.x=r.x+n.x,r.y=r.y+n.y},i=function(e){},s=function(e,n,i){r(e.text_label_id,n),t.draw_these_text_labels([e.text_label_id])},o=function(e){},u=function(n,i){r(n.text_label_id,e.c_times_scalar(i,-1)),t.draw_these_text_labels([n.text_label_id])},a=function(e,n){r(e.text_label_id,n),t.draw_these_text_labels([e.text_label_id])};return this.get_generic_drag(i,s,o,u,a)}function v(t,n,r,i,s){var o=d3.behavior.drag(),u,a=this.map.scale,f=this.undo_stack;return o.on("dragstart",function(e){d3.event.sourceEvent.stopPropagation(),u={x:0,y:0},t(e)}),o.on("drag",function(t){var r={x:a.x_size.invert(d3.event.dx),y:a.y_size.invert(d3.event.dy)};u=e.c_plus_c(u,r),n(t,r,u)}),o.on("dragend",function(t){var n=e.clone(t),o=e.clone(u);f.push(function(){i(n,o)},function(){s(n,o)}),r(t)}),o}var n=e.make_class();return n.prototype={init:r,turn_everything_on:i,turn_everything_off:s,toggle_node_click:o,toggle_node_drag:a,toggle_text_label_click:u,toggle_label_drag:f,get_node_drag:l,get_bezier_drag:c,get_reaction_label_drag:h,get_node_label_drag:p,get_text_label_drag:d,get_generic_drag:v},n}),n("Scale",["utils"],function(e){function n(t,n,r,i,s){var o=e.set_options(s,{flux_color:d3.scale.linear().domain([0,1e-6,1,8,50]).range(["rgb(200,200,200)","rgb(190,190,255)","rgb(100,100,255)","blue","red"])}),u=Math.min(r/t,i/n);o.x=d3.scale.linear().domain([0,t]).range([(r-t*u)/2,t*u+(r-t*u)/2]),o.y=d3.scale.linear().domain([0,n]).range([(i-n*u)/2,n*u+(i-n*u)/2]),o.x_size=d3.scale.linear().domain([0,t]).range([0,t*u]),o.y_size=d3.scale.linear().domain([0,n]).range([0,n*u]),o.size=d3.scale.linear().domain([0,1]).range([0,u]),o.flux=d3.scale.linear().domain([0,40]).range([6,6]),o.flux_fill=d3.scale.linear().domain([0,40,200]).range([1,1,1]),o.node_size=d3.scale.linear().range([5,25]),o.node_color=d3.scale.linear().range(["white","red"]),o.metabolite_concentration=d3.scale.linear().domain([0,10]).range([15,200]),o.metabolite_color=d3.scale.linear().domain([0,1.2]).range(["#FEF0D9","#B30000"]),o.scale_path=function(e){var t=o.x,n=o.y,r=d3.format(".2f"),e=e.replace(/(M|L)([0-9-.]+),?\s*([0-9-.]+)/g,function(e,i,s,o){return i+[r(t(parseFloat(s))),r(n(parseFloat(o)))].join(", ")}),i=/C([0-9-.]+),?\s*([0-9-.]+)\s*([0-9-.]+),?\s*([0-9-.]+)\s*([0-9-.]+),?\s*([0-9-.]+)/g;return e=e.replace(i,function(e,i,s,o,u,a,f){return"C"+r(t(parseFloat(i)))+","+r(n(parseFloat(s)))+" "+r(t(parseFloat(o)))+","+r(n(parseFloat(u)))+" "+[r(t(parseFloat(a)))+","+r(n(parseFloat(f)))]}),e},o.scale_decimals=function(e,t,n){var r=d3.format("."+String(n)+"f");return e=e.replace(/([0-9.]+)/g,function(e,n){return r(t(parseFloat(n)))}),e};var a=window.Object.keys(o),f=-1;while(++f<a.length)this[a[f]]=o[a[f]]}var t=e.make_class();return t.prototype={init:n},t}),n("DirectionArrow",["utils"],function(e){function n(e){function t(){return"M0 -5 L0 5 L20 5 L20 10 L30 0 L20 -10 L20 -5 Z"}this.arrow_container=e.append("g").attr("id","direction-arrow-container").attr("transform","translate(0,0)rotate(0)"),this.arrow=this.arrow_container.append("path").classed("direction-arrow",!0).attr("d",t()).style("visibility","hidden").attr("transform","translate(2,0)scale(0.15)")}function r(e){var t=d3.transform(this.arrow_container.attr("transform"));this.arrow_container.attr("transform","translate("+e.x+","+e.y+")rotate("+t.rotate+")")}function i(e){var t=d3.transform(this.arrow_container.attr("transform"));this.arrow_container.attr("transform","translate("+t.translate+")rotate("+e+")")}function s(){return d3.transform(this.arrow_container.attr("transform")).rotate}function o(){this.arrow.style("visibility","visible")}function u(){this.arrow.style("visibility","hidden")}function a(){this.set_rotation(0)}function f(){this.set_rotation(90)}function l(){this.set_rotation(180)}function c(){this.set_rotation(270)}var t=e.make_class();return t.prototype={init:n,set_location:r,set_rotation:i,get_rotation:s,show:o,hide:u,right:a,left:l,up:c,down:f},t}),n("UndoStack",["utils"],function(e){function n(){var e=40;this.stack=Array(e),this.current=-1,this.oldest=-1,this.newest=-1,this.end_of_stack=!0,this.top_of_stack=!0}function r(e,t){this.current=o(this.current,this.stack.length),this.end_of_stack?this.oldest=this.current:this.oldest==this.current&&(this.oldest=o(this.oldest,this.stack.length)),this.stack[this.current]={undo:e,redo:t},this.newest=this.current,this.top_of_stack=!0,this.end_of_stack=!1}function i(){if(this.end_of_stack)return console.warn("End of stack.");this.stack[this.current].undo(),this.current==this.oldest?this.end_of_stack=!0:this.current=u(this.current,this.stack.length),this.top_of_stack=!1}function s(){if(this.top_of_stack)return console.warn("Top of stack.");this.end_of_stack||(this.current=o(this.current,this.stack.length)),this.stack[this.current].redo(),this.current==this.newest&&(this.top_of_stack=!0),this.end_of_stack=!1}function o(e,t){return e+1>t-1?0:e+1}function u(e,t){return e-1<0?t-1:e-1}var t=e.make_class();return t.prototype={init:n,push:r,undo:i,redo:s},t}),n("CallbackManager",["utils"],function(e){function n(){}function r(e,t){return this.callbacks===undefined&&(this.callbacks={}),this.callbacks[e]===undefined&&(this.callbacks[e]=[]),this.callbacks[e].push(t),this}function i(e){return(this.callbacks===undefined||Object.keys(this.callbacks).length==0)&&console.warn("No callbacks to remove"),delete this.callbacks[e],this}function s(e){if(this.callbacks===undefined)return this;var t=Array.prototype.slice.call(arguments,1);for(var n in this.callbacks){var r=n.split(".")[0];r==e&&this.callbacks[n].forEach(function(e){e.apply(null,t)})}return this}var t=e.make_class();return t.prototype={init:n,set:r,remove:i,run:s},t}),n("KeyManager",["utils"],function(e){function n(e){e.command=!1,e.control=!1,e.option=!1,e.shift=!1}function r(e,t){e===undefined?this.assigned_keys={}:this.assigned_keys=e,t===undefined?this.reaction_input=null:this.reaction_input=t,this.held_keys={},n(this.held_keys),this.update()}function i(){function s(e,t,n,r){for(var i in e)e[i]==n&&(t[i]=r)}function o(e,t,n){if(e.key!=t)return!1;var r=e.modifiers;r===undefined&&(r={control:!1,command:!1,option:!1,shift:!1});for(var i in n){r[i]===undefined&&(r[i]=!1);if(r[i]!=n[i])return!1}return!0}var e=this.held_keys,t=this.assigned_keys,r=this,i={command:91,control:17,option:18,shift:16};d3.select(window).on("keydown.key_manager",null),d3.select(window).on("keyup.key_manager",null),d3.select(window).on("keydown.key_manager",function(){var u=d3.event.keyCode,a=r.reaction_input?r.reaction_input.is_visible:!1,f=!0;s(i,e,u,!0);for(var l in t){var c=t[l];if(o(c,u,e)){f=!1;if(!c.ignore_with_input||!a)c.fn?c.fn.call(c.target):console.warn("No function for key"),d3.event.preventDefault()}}for(var h in i)i[h]==u&&(f=!1);f&&n(e)}).on("keyup.key_manager",function(){s(i,e,d3.event.keyCode,!1)})}function s(e){var t=d3.select(window);return t.on("keydown.esc",function(){d3.event.keyCode==27&&(e(),t.on("keydown.esc",null))}),{clear:function(){t.on("keydown.esc",null)}}}var t=e.make_class();return t.reset_held_keys=n,t.prototype={init:r,update:i,add_escape_listener:s},t}),n("Canvas",["utils"],function(e){function n(e,t){this.selection=e,this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this.setup()}function r(){function p(){d3.event.sourceEvent.stopPropagation()}function d(e,t,n){var r=d3.transform(n),i=r.translate;return e!==null&&(i[0]=e),t!==null&&(i[1]=t),"translate("+i+")"}function v(t){var r=t.x;t.x=Math.min(t.x+e.width-n/2,d3.event.x),e.x=t.x,e.width=e.width+(r-t.x),f.attr("transform",function(e){return d(e.x-n/2,null,f.attr("transform"))}),i.attr("transform",function(e){return d(e.x,null,i.attr("transform"))}).attr("width",e.width),c.attr("transform",function(e){return d(e.x+n/2,null,c.attr("transform"))}).attr("width",e.width-n),h.attr("transform",function(e){return d(e.x+n/2,null,h.attr("transform"))}).attr("width",e.width-n)}function m(t){d3.event.sourceEvent.stopPropagation();var r=Math.max(t.x+n/2,t.x+e.width+d3.event.dx);e.width=r-t.x,l.attr("transform",function(e){return d(r-n/2,null,l.attr("transform"))}),i.attr("width",e.width),c.attr("width",e.width-n),h.attr("width",e.width-n)}function g(t){d3.event.sourceEvent.stopPropagation();var r=t.y;t.y=Math.min(t.y+e.height-n/2,d3.event.y),e.y=t.y,e.height=e.height+(r-t.y),c.attr("transform",function(e){return d(null,e.y-n/2,c.attr("transform"))}),i.attr("transform",function(e){return d(null,e.y,i.attr("transform"))}).attr("height",e.height),f.attr("transform",function(e){return d(null,e.y+n/2,f.attr("transform"))}).attr("height",e.height-n),l.attr("transform",function(e){return d(null,e.y+n/2,l.attr("transform"))}).attr("height",e.height-n)}function y(t){d3.event.sourceEvent.stopPropagation();var r=Math.max(t.y+n/2,t.y+e.height+d3.event.dy);e.height=r-t.y,h.attr("transform",function(e){return d(null,r-n/2,h.attr("transform"))}),i.attr("height",e.height),f.attr("height",e.height-n),l.attr("height",e.height-n)}var e=this,t={x:this.width,y:this.height},n=20,r=this.selection.append("g").classed("canvas-group",!0).data([{x:this.x,y:this.y}]),i=r.append("rect").attr("id","mouse-node").attr("width",this.width).attr("height",this.height).attr("transform","translate("+[e.x,e.y]+")").attr("class","canvas").attr("pointer-events","all"),s=d3.behavior.drag().origin(Object).on("dragstart",p).on("drag",m),o=d3.behavior.drag().origin(Object).on("dragstart",p).on("drag",v),u=d3.behavior.drag().origin(Object).on("dragstart",p).on("drag",g),a=d3.behavior.drag().origin(Object).on("dragstart",p).on("drag",y),f=r.append("rect").attr("transform",function(e){return"translate("+[e.x-n/2,e.y+n/2]+")"}).attr("height",this.height-n).attr("id","dragleft").attr("width",n).attr("cursor","ew-resize").classed("resize-rect",!0).call(o),l=r.append("rect").attr("transform",function(t){return"translate("+[t.x+e.width-n/2,t.y+n/2]+")"}).attr("id","dragright").attr("height",this.height-n).attr("width",n).attr("cursor","ew-resize").classed("resize-rect",!0).call(s),c=r.append("rect").attr("transform",function(e){return"translate("+[e.x+n/2,e.y-n/2]+")"}).attr("height",n).attr("id","dragleft").attr("width",this.width-n).attr("cursor","ns-resize").classed("resize-rect",!0).call(u),h=r.append("rect").attr("transform",function(t){return"translate("+[t.x+n/2,t.y+e.height-n/2]+")"}).attr("id","dragright").attr("height",n).attr("width",this.width-n).attr("cursor","ns-resize").classed("resize-rect",!0).call(a)}function i(){return{x:this.x,y:this.y,width:this.width,height:this.height}}var t=e.make_class();return t.prototype={init:n,setup:r,size_and_location:i},t}),n("Map",["utils","draw","Behavior","Scale","DirectionArrow","build","UndoStack","CallbackManager","KeyManager","Canvas"],function(e,t,n,r,i,s,o,u,a,f){function c(e,t,s,l,c,h,p,d,v,m){m===undefined&&(m={x:0,y:0,width:c,height:l});var g=90;this.reaction_arrow_displacement=35,this.default_reaction_color="#334E75",this.canvas=new f(e,m),this.setup_containers(e),this.sel=e,this.defs=t,this.zoom_container=s,this.height=l,this.width=c,this.flux=h,this.node_data=p,this.node_data_style=d,this.cobra_model=v,this.map_info={max_map_w:c*10,max_map_h:l*10},this.map_info.largest_ids={reactions:-1,nodes:-1,segments:-1},this.scale=new r(this.map_info.max_map_w,this.map_info.max_map_h,c,l),this.undo_stack=new o,this.behavior=new n(this,this.undo_stack),this.key_manager=new a;var y={x:0,y:0},b=1;this.beziers_enabled=!1,this.direction_arrow=new i(e),this.direction_arrow.set_rotation(g),this.callback_manager=new u,this.arrowheads_generated=[],this.nodes={},this.reactions={},this.membranes=[],this.text_labels={},this.info={},this.debug=!1}function h(t,n,r,i,s,o,u,a,f,c){function g(e,t){return t===undefined&&(t=0),e===undefined?t:Math.max.apply(null,Object.keys(e).map(function(e){return parseInt(e)}).concat([t]))}e.check_undefined(arguments,["map_data","selection","defs","zoom_container","height","width","flux","node_data","node_data_style","cobra_model"]),t=p(t);var h;t.canvas&&(h=t.canvas);var d=new l(n,r,i,s,o,u,a,f,c,h);t.reactions&&(d.reactions=t.reactions),t.nodes&&(d.nodes=t.nodes),t.membranes&&(d.membranes=t.membranes),t.text_labels&&(d.text_labels=t.text_labels),t.info&&(d.info=t.info),d.map_info.largest_ids.reactions=g(d.reactions),d.map_info.largest_ids.nodes=g(d.nodes),d.map_info.largest_ids.text_labels=g(d.text_labels);var v=0;for(var m in d.reactions)v=g(d.reactions[m].segments,v);return d.map_info.largest_ids.segments=v,d.apply_flux_to_map(),d.apply_node_data_to_map(),d}function p(e){if(this.debug){var t=["node_type","x","y","connected_segments"],n=["segments","name","direction","abbreviation"],r=["from_node_id","to_node_id"],i=["text","x","y"];for(var s in e.nodes){var o=e.nodes[s];o.selected=!1,o.previously_selected=!1,t.map(function(e){o.hasOwnProperty(e)||console.error("Missing property "+e)})}for(var u in e.reactions){var a=e.reactions[u];n.map(function(e){a.hasOwnProperty(e)||console.error("Missing property "+e)});for(var f in a.segments){var l=a.segments[f];r.map(function(e){l.hasOwnProperty(e)||console.error("Missing property "+e)})}}for(var c in e.text_labels){var h=e.text_labels[c];i.map(function(e){h.hasOwnProperty(e)||console.error("Missing property "+e)})}}return e}function d(e){e.append("g").attr("id","membranes"),e.append("g").attr("id","reactions"),e.append("g").attr("id","nodes"),e.append("g").attr("id","text-labels")}function v(){d3.select("#membranes").selectAll(".membrane").remove(),d3.select("#reactions").selectAll(".reaction").remove(),d3.select("#nodes").selectAll(".node").remove(),d3.select("#text-labels").selectAll(".text-label").remove()}function m(e){this.status=e,this.callback_manager.run("set_status",e)}function g(e){this.cobra_model=e}function y(e){this.flux=e,this.apply_flux_to_map(),this.draw_all_reactions()}function b(e){this.node_data=e,this.apply_node_data_to_map(),this.draw_all_nodes()}function w(){return this.flux!==null}function E(){return this.node_data!==null}function S(){var n=this.membranes,r=this.scale,i=this.reactions,s=this.nodes,o=this.text_labels,u=this.reaction_arrow_displacement,a=this.defs,f=this.arrowheads_generated,l=this.default_reaction_color,c=this.behavior.bezier_drag,h=this.behavior.node_click,p=this.behavior.node_drag,d=this.behavior.reaction_label_drag,v=this.behavior.node_label_drag,m=this.behavior.text_label_click,g=this.behavior.text_label_drag,y=this.node_data_style,b=this.has_flux(),w=this.has_node_data(),E=this.beziers_enabled;e.draw_an_array("#membranes",".membrane",n,t.create_membrane,function(e){return t.update_membrane(e,r)}),e.draw_an_object("#reactions",".reaction",i,"reaction_id",function(e){return t.create_reaction(e)},function(e){return t.update_reaction(e,r,s,E,u,a,f,l,b,c,d)}),e.draw_an_object("#nodes",".node",s,"node_id",function(e){return t.create_node(e,r,s,i)},function(e){return t.update_node(e,r,w,y,h,p,v)}),e.draw_an_object("#text-labels",".text-label",o,"text_label_id",function(e){return t.create_text_label(e)},function(e){return t.update_text_label(e,r,m,g)})}function x(){var e=[];for(var t in this.reactions)e.push(t);this.draw_these_reactions(e)}function T(n){var r=this.scale,i=this.reactions,s=this.nodes,o=this.reaction_arrow_displacement,u=this.defs,a=this.arrowheads_generated,f=this.default_reaction_color,l=this.behavior.bezier_drag,c=this.behavior.reaction_label_drag,h=this.has_flux(),p=this.beziers_enabled,d={},v=-1;while(++v<n.length)d[n[v]]=e.clone(i[n[v]]);n.length!=Object.keys(d).length&&console.warn("did not find correct reaction subset");var m=d3.select("#reactions").selectAll(".reaction").data(e.make_array(d,"reaction_id"),function(e){return e.reaction_id});m.enter().call(t.create_reaction),m.call(function(e){return t.update_reaction(e,r,s,p,o,u,a,f,h,l,c)}),m.exit()}function N(){var e=[];for(var t in this.nodes)e.push(t);this.draw_these_nodes(e)}function C(n){var r=this.scale,i=this.reactions,s=this.nodes,o=this.behavior.node_click,u=this.behavior.node_drag,a=this.behavior.node_label_drag,f=this.node_data_style,l=this.has_node_data(),c={},h=-1;while(++h<n.length)c[n[h]]=e.clone(s[n[h]]);n.length!=Object.keys(c).length&&console.warn("did not find correct node subset");var p=d3.select("#nodes").selectAll(".node").data(e.make_array(c,"node_id"),function(e){return e.node_id});p.enter().call(function(e){return t.create_node(e,r,s,i)}),p.call(function(e){return t.update_node(e,r,l,f,o,u,a)}),p.exit()}function k(n){var r=this.scale,i=this.text_labels,s=this.behavior.text_label_click,o=this.behavior.text_label_drag,u={},a=-1;while(++a<n.length)u[n[a]]=e.clone(i[n[a]]);n.length!=Object.keys(u).length&&console.warn("did not find correct text label subset");var f=d3.select("#text-labels").selectAll(".text-label").data(e.make_array(u,"text_label_id"),function(e){return e.text_label_id});f.enter().call(function(e){return t.create_text_label(e)}),f.call(function(e){return t.update_text_label(e,r,s,o)}),f.exit()}function L(){this.apply_flux_to_reactions(this.reactions)}function A(e){for(var t in e){var n=e[t];if(this.flux!==null&&n.abbreviation in this.flux){var r=parseFloat(this.flux[n.abbreviation]);isNaN(r)&&(r=null),n.flux=r;for(var i in n.segments){var s=n.segments[i];s.flux=r}}else{var r=null;n.flux=r;for(var i in n.segments){var s=n.segments[i];s.flux=r}}}}function O(){this.apply_node_data_to_nodes(this.nodes)}function M(e){var t=[];for(var n in e){var r=e[n],i=0;this.node_data!==null&&r.bigg_id_compartmentalized in this.node_data?(i=parseFloat(this.node_data[r.bigg_id_compartmentalized]),isNaN(i)?i=null:t.push(i),r.data=i):r.data=null}var s=Math.min.apply(null,t),o=Math.max.apply(null,t);this.scale.node_size.domain([s,o]),this.scale.node_color.domain([s,o])}function _(e){var t=this.nodes[e],n={x:t.x,y:t.y};return n}function D(){var e=[];return d3.select("#nodes").selectAll(".selected").each(function(t){e.push(t.node_id)}),e}function P(){var e={},t=this;return d3.select("#nodes").selectAll(".selected").each(function(n){e[n.node_id]=t.nodes[n.node_id]}),e}function H(){var e=[];return d3.select("#text-labels").selectAll(".selected").each(function(t){e.push(t.text_label_id)}),e}function B(){var e={},t=this;return d3.select("#text-labels").selectAll(".selected").each(function(n){e[n.text_label_id]=t.text_labels[n.text_label_id]}),e}function j(e){this.deselect_text_labels();var t=this.sel.select("#nodes").selectAll(".node"),n,r=this.scale,i;t.classed("selected",function(t){var s=String(t.node_id)==String(e);return s&&(i=t,n={x:r.x(t.x),y:r.y(t.y)}),s}),this.direction_arrow.set_location(n),this.direction_arrow.show(),this.sel.selectAll(".start-reaction-target").style("visibility","hidden"),this.callback_manager.run("select_metabolite_with_id",i,n)}function F(e,t){this.deselect_text_labels();var n=this.sel.select("#nodes").selectAll(".node"),r=this.key_manager.held_keys.shift;r?d3.select(e.parentNode).classed("selected",!d3.select(e.parentNode).classed("selected")):n.classed("selected",function(e){return t===e});var i=d3.select("#nodes").selectAll(".selected"),s=0,o,u=this.scale,a;i.each(function(e){a=e,o={x:u.x(e.x),y:u.y(e.y)},s++}),s==1?(this.direction_arrow.set_location(o),this.direction_arrow.show()):this.direction_arrow.hide(),this.callback_manager.run("select_metabolite",s,a,o)}function I(){var e=null,t=this,n=this.sel.select("#nodes").selectAll(".selected");return n.classed("selected",function(t,n){return n==0?(e=t,!0):!1}),e}function q(){var e=this.sel.select("#nodes").selectAll(".node");e.classed("selected",!1)}function R(e,t){this.deselect_nodes();var n=this.sel.select("#text-labels").selectAll(".text-label");n.classed("selected",function(e){return t===e});var r=d3.select("#text-labels").selectAll(".selected"),i,s=this.scale;r.each(function(e){i={x:s.x(e.x),y:s.y(e.y)}}),this.callback_manager.run("select_text_label")}function U(){var e=this.sel.select("#text-labels").selectAll(".text-label");e.classed("selected",!1)}function z(){var e=this.get_selected_nodes();Object.keys(e).length>=1&&this.delete_nodes(e);var t=this.get_selected_text_labels();Object.keys(t).length>=1&&this.delete_text_labels(t)}function W(t){var n=this.segments_and_reactions_for_nodes(t),r=n.reactions,i=n.segment_objs_w_segments,s=e.clone(t),o=e.clone(i),u=e.clone(r),a=this,f=function(e,n,r){a.delete_node_data(t),a.delete_segment_data(r),a.delete_reaction_data(n),a.draw_everything()};f(t,r,i),this.undo_stack.push(function(){e.extend(a.nodes,s),e.extend(a.reactions,u);var n=Object.keys(u);o.forEach(function(e){var t=e.segment;a.reactions[e.reaction_id].segments[e.segment_id]=t,[t.from_node_id,t.to_node_id].forEach(function(t){if(t in s)return;var n=a.nodes[t];n.connected_segments.push({reaction_id:e.reaction_id,segment_id:e.segment_id})}),n.push(e.reaction_id)}),a.draw_these_nodes(Object.keys(s)),a.draw_these_reactions(n),t=e.clone(s),i=e.clone(o),r=e.clone(u)},function(){f(t,r,i)})}function X(t){var n=e.clone(t),r=this,i=function(e){r.delete_text_label_data(t),r.draw_everything()};i(t),this.undo_stack.push(function(){e.extend(r.text_labels,n),r.draw_these_text_labels(Object.keys(n)),t=e.clone(n)},function(){i(t)})}function V(e){for(var t in e)delete this.nodes[t]}function $(e){var t=this.reactions,n=this.nodes;e.forEach(function(e){var r=t[e.reaction_id];if(!(e.segment_id in r.segments))return;var i=r.segments[e.segment_id];[i.from_node_id,i.to_node_id].forEach(function(t){if(!(t in n))return;var r=n[t];r.connected_segments=r.connected_segments.filter(function(t){return t.segment_id!=e.segment_id})}),delete r.segments[e.segment_id]})}function J(e){for(var t in e)delete this.reactions[t]}function K(e){for(var t in e)delete this.text_labels[t]}function Q(){this.toggle_beziers(!0)}function G(){this.toggle_beziers(!1)}function Y(e){e===undefined?this.beziers_enabled=!this.beziers_enabled:this.beziers_enabled=e,this.draw_everything(),this.callback_manager.run("toggle_beziers",this.beziers_enabled)}function Z(t,n){function p(t,n){this.apply_node_data_to_nodes(t),e.extend(this.nodes,t),this.draw_these_nodes([n])}for(var r in this.reactions)if(this.reactions[r].abbreviation==t)return console.warn("reaction is already drawn"),null;if(!this.cobra_model)return console.error("No CobraModel. Cannot build new reaction");var i=e.clone(this.cobra_model.reactions[t]);for(var s in i.metabolites){var o=i.metabolites[s];if(o.coefficient<0){var u=++this.map_info.largest_ids.nodes,a={x:30,y:10},f={connected_segments:[],x:n.x,y:n.y,node_is_primary:!0,compartment_id:o.compartment_id,label_x:n.x+a.x,label_y:n.y+a.y,metabolite_name:o.name,bigg_id:o.bigg_id,bigg_id_compartmentalized:o.bigg_id_compartmentalized,node_type:"metabolite"},l={};l[u]=f;break}}p.apply(this,[l,u]);var c=e.clone(l),h=this;return this.undo_stack.push(function(){h.delete_node_data(l),l=e.clone(c),h.draw_everything()},function(){p.apply(h,[l,u])}),this.new_reaction_for_metabolite(t,u),null}function et(t,n){function p(t,n,r){e.extend(this.reactions,n),delete this.nodes[r],e.extend(this.nodes,t),this.apply_node_data_to_nodes(t),this.apply_flux_to_reactions(n),this.draw_these_nodes(Object.keys(t)),this.draw_these_reactions(Object.keys(n));for(var i in t){var s=t[i];if(s.node_is_primary&&i!=r){this.select_metabolite_with_id(i);var o={x:s.x,y:s.y};this.zoom_container&&this.zoom_container.translate_off_screen(o,this.scale.x,this.scale.y)}}}for(var r in this.reactions)if(this.reactions[r].abbreviation==t){console.warn("reaction is already drawn");return}var i=this.nodes[n],o=e.clone(this.cobra_model.reactions[t]),u=s.new_reaction(t,o,n,e.clone(i),this.map_info.largest_ids,this.cobra_model.cofactors,this.direction_arrow.get_rotation()),a=u.new_nodes,f=u.new_reactions;this.flux&&this.apply_flux_to_reactions(f),this.node_data&&this.apply_node_data_to_nodes(a),p.apply(this,[a,f,n]);var l=e.clone(a),c=e.clone(f),h=this;this.undo_stack.push(function(){delete a[n],h.delete_node_data(a),h.delete_reaction_data(f),j.apply(h,[n]),a=e.clone(l),f=e.clone(c),h.draw_everything()},function(){p.apply(h,[a,f,n])})}function tt(){var e=this.get_selected_nodes(),t=Object.keys(e)[0],n=e[t],r=this.reactions,i=this.nodes,s=[],o;i[t].connected_segments.forEach(function(e){o=[e.reaction_id];var n=r[e.reaction_id].segments[e.segment_id];s.push(n.from_node_id==t?n.to_node_id:n.from_node_id)});if(s.length!=1)return console.error("Only connected nodes with a single reaction can be selected");var u=s[0],a=[t],f=[];i[u].connected_segments.forEach(function(e){var n=r[e.reaction_id].segments[e.segment_id],s=n.from_node_id==u?n.to_node_id:n.from_node_id,o=i[s];o.node_type=="metabolite"&&s!=t&&a.push(String(s))});for(var l=0;l<a.length;l++)if(i[a[l]].connected_segments.length>1)return console.error("Only connected nodes with a single reaction can be selected");for(var c in e)if(c!=t&&a.indexOf(c)==-1)return console.warn("Selected nodes are not on the same reaction");var h=[],p=a.length-1,d=i[a[p]],v=d.node_is_primary,m={x:d.x,y:d.y,label_x:d.label_x,label_y:d.label_y},g=d.connected_segments[0],y=r[g.reaction_id].segments[g.segment_id],b={b1:y.b1,b2:y.b2},w;a.forEach(function(e){var t=i[e],n=t.node_is_primary,s={x:t.x,y:t.y,label_x:t.label_x,label_y:t.label_y},o=t.connected_segments[0],u=r[o.reaction_id].segments[o.segment_id],a={b1:u.b1,b2:u.b2};t.node_is_primary=v,t.x=m.x,t.y=m.y,t.label_x=m.label_x,t.label_y=m.label_y,u.b1=b.b1,u.b2=b.b2,v=n,m=s,b=a,t.node_is_primary&&(w=e),h.push(e)});var E=i[u].connected_segments,p=E.length-1,S=[E[p]];E.forEach(function(e,t){if(p==t)return;S.push(e)}),i[u].connected_segments=S,this.draw_these_nodes(h),this.draw_these_reactions(o),this.select_metabolite_with_id(w)}function nt(){var e=this.get_selected_nodes(),t=this.reactions,n=this.nodes;if(Object.keys(e).length!=1)return console.error("Only one node can be selected");var r=Object.keys(e)[0],i=e[r];n[r].node_is_primary=!0;var s=[r],o=[];n[r].connected_segments.forEach(function(e){var n=t[e.reaction_id].segments[e.segment_id];o.push(n.from_node_id==r?n.to_node_id:n.from_node_id)}),o.forEach(function(e){var i=[];n[e].connected_segments.forEach(function(i){var o=t[i.reaction_id].segments[i.segment_id],u=o.from_node_id==e?o.to_node_id:o.from_node_id,a=n[u];a.node_type=="metabolite"&&u!=r&&(a.node_is_primary=!1,s.push(u))})}),this.draw_these_nodes(s)}function rt(){function f(e,t){console.log("Choose center"),m("Choose a node or point to rotate around.");var n=d3.selectAll(".node-circle"),r=d3.selectAll("#mouse-node"),i=this.scale,s=this.key_manager.add_escape_listener(function(){console.log("choose_center escape"),n.on("mousedown.center",null),r.on("mousedown.center",null),m(""),t()});n.on("mousedown.center",function(t){console.log("mousedown.center"),n.on("mousedown.center",null),r.on("mousedown.center",null),m(""),s.clear();var i={x:t.x,y:t.y};e(i)}),r.on("mousedown.center",function(){console.log("mousedown.center"),n.on("mousedown.center",null),r.on("mousedown.center",null),m(""),s.clear();var t={x:i.x_size.invert(d3.mouse(this)[0]),y:i.y_size.invert(d3.mouse(this)[1])};e(t)})}function l(e,t,n,r){function f(e,t,n){var r=Math.atan2(t.x-n.x,n.y-t.y),i=Math.atan2(t.x-n.x+e.dx,n.y-t.y-e.dy),s=i-r;return s}this.set_status("Drag to rotate."),this.zoom_container.toggle_zoom(!1);var i=Math.PI/2,s=d3.selectAll("#mouse-node"),o=d3.behavior.drag(),u=this.scale,a=this.key_manager.add_escape_listener(function(){console.log("listen_for_rotation escape"),o.on("drag.rotate",null),o.on("dragend.rotate",null),m(""),r()});o.on("drag.rotate",function(){t(f({dx:u.x_size.invert(d3.event.dx),dy:u.y_size.invert(d3.event.dy)},{x:u.x_size.invert(d3.mouse(this)[0]),y:u.y_size.invert(d3.mouse(this)[1])},e))}).on("dragend.rotate",function(){console.log("dragend.rotate"),o.on("drag.rotate",null),o.on("dragend.rotate",null),m(""),a.clear(),n()}),s.call(o)}this.callback_manager.run("start_rotation");var e=this.get_selected_nodes();if(e.length<1)return console.warn("No nodes selected");var t,n=0,r=Object.keys(e),i=this,o=this.reactions,u=this.nodes,a=function(){i.callback_manager.run("end_rotation")};f.call(this,function(r){t=r,l.call(i,r,function(t){n+=t;var u=s.rotate_nodes(e,o,t,r);i.draw_these_nodes(u.node_ids),i.draw_these_reactions(u.reaction_ids)},a,a)},a),this.undo_stack.push(function(){var e={};r.forEach(function(t){e[t]=u[t]});var a=s.rotate_selected_nodes(e,o,-n,t);i.draw_these_nodes(a.node_ids),i.draw_these_reactions(a.reaction_ids)},function(){var e={};r.forEach(function(t){e[t]=u[t]});var a=s.rotate_selected_nodes(e,o,n,t);i.draw_these_nodes(a.node_ids),i.draw_these_reactions(a.reaction_ids)})}function it(t){var n=[],r={},i={},s=this.reactions;for(var o in t){var u=t[o];u.connected_segments.forEach(function(t){var r=s[t.reaction_id],o=r.segments[t.segment_id],u=e.clone(t);u.segment=e.clone(o),n.push(u),t.reaction_id in i||(i[t.reaction_id]=[]),i[t.reaction_id].push(t.segment_id)})}for(var a in i){var f=s[a],l=i[a],c=!0;for(var h in f.segments)l.indexOf(h)==-1&&(c=!1);c&&(r[a]=f)}return{segment_objs_w_segments:n,reactions:r}}function m(e){var t=d3.select("body").select("#status");return t.empty()&&(t=d3.select("body").append("text").attr("id","status")),t.text(e),this}function st(e){this._zoom_extent(e,"nodes")}function ot(e){this._zoom_extent(e,"canvas")}function ut(e,t){e===undefined&&(e=100),t===undefined&&(t="canvas");var n,r;if(t=="nodes"){var i={x:null,y:null},s={x:null,y:null};for(var o in this.nodes){var u=this.nodes[o];i.x===null&&(i.x=this.scale.x(u.x)),i.y===null&&(i.y=this.scale.y(u.y)),s.x===null&&(s.x=this.scale.x(u.x)),s.y===null&&(s.y=this.scale.y(u.y)),i.x=Math.min(i.x,this.scale.x(u.x)),i.y=Math.min(i.y,this.scale.y(u.y)),s.x=Math.max(s.x,this.scale.x(u.x)),s.y=Math.max(s.y,this.scale.y(u.y))}n=Math.min((this.width-e*2)/(s.x-i.x),(this.height-e*2)/(s.y-i.y)),r={x:-(i.x*n)+e+(this.width-e*2-(s.x-i.x)*n)/2,y:-(i.y*n)+e+(this.height-e*2-(s.y-i.y)*n)/2}}else{if(t!="canvas")return console.error("Did not recognize mode");n=Math.min((this.width-e*2)/this.canvas.width,(this.height-e*2)/this.canvas.height),r={x:-(this.canvas.x*n)+e+(this.width-e*2-this.canvas.width*n)/2,y:-(this.canvas.y*n)+e+(this.height-e*2-this.canvas.height*n)/2}}return this.zoom_container.go_to(n,r),null}function at(){console.log("Saving"),e.download_json(this.map_for_export(),"saved_map")}function ft(){return{reactions:this.reactions,nodes:this.nodes,membranes:this.membranes,text_labels:this.text_labels,canvas:this.canvas.size_and_location()}}function lt(){console.log("Exporting SVG"),this.callback_manager.run("before_svg_export"),e.export_svg("saved_map","svg"),this.callback_manager.run("after_svg_export")}var l=e.make_class();return l.from_data=h,l.prototype={init:c,setup_containers:d,reset_containers:v,set_status:m,set_model:g,set_flux:y,set_node_data:b,select_metabolite:F,select_metabolite_with_id:j,select_single_node:I,deselect_nodes:q,select_text_label:R,deselect_text_labels:U,new_reaction_from_scratch:Z,new_reaction_for_metabolite:et,cycle_primary_node:tt,make_selected_node_primary:nt,rotate_selected_nodes:rt,delete_selected:z,delete_nodes:W,delete_text_labels:X,delete_node_data:V,delete_segment_data:$,delete_reaction_data:J,delete_text_label_data:K,get_selected_node_ids:D,get_selected_nodes:P,get_selected_text_label_ids:H,get_selected_text_labels:B,segments_and_reactions_for_nodes:it,has_flux:w,has_node_data:E,draw_everything:S,draw_all_reactions:x,draw_these_reactions:T,draw_all_nodes:N,draw_these_nodes:C,draw_these_text_labels:k,apply_flux_to_map:L,apply_flux_to_reactions:A,apply_node_data_to_map:O,apply_node_data_to_nodes:M,get_selected_node_ids:D,toggle_beziers:Y,hide_beziers:G,show_beziers:Q,zoom_extent_nodes:st,zoom_extent_canvas:ot,_zoom_extent:ut,save:at,map_for_export:ft,save_svg:lt},l}),n("ZoomContainer",["utils","CallbackManager"],function(e,t){function r(e,n,r,i){this.zoom_on=!0,this.initial_zoom=1,this.window_translate={x:0,y:0},this.window_scale=1,this.width=n,this.height=r,this.callback_manager=new t,e.select("#zoom-container").remove();var s=e.append("g").attr("id","zoom-container");this.zoomed_sel=s.append("g");var o=function(e,t){e.zoom_on&&(e.zoomed_sel.attr("transform","translate("+t.translate+")"+"scale("+t.scale+")"),e.window_translate={x:t.translate[0],y:t.translate[1]},e.window_scale=t.scale,e.callback_manager.run("zoom"))},u=this;this.zoom_behavior=d3.behavior.zoom().on("zoom",function(){o(u,d3.event)}),s.call(this.zoom_behavior),this.saved_scale=null,this.saved_translate=null}function i(t){t===undefined?this.zoom_on=!this.zoom_on:this.zoom_on=t,this.zoom_on?(this.saved_scale!==null&&(this.zoom_behavior.scale(this.saved_scale),this.saved_scale=null),this.saved_translate!==null&&(this.zoom_behavior.translate(this.saved_translate),this.saved_translate=null)):(this.saved_scale===null&&(this.saved_scale=e.clone(this.zoom_behavior.scale())),this.saved_translate===null&&(this.saved_translate=e.clone(this.zoom_behavior.translate())))}function s(e,t){if(!e)return console.error("Bad scale value");if(!!t&&"x"in t&&"y"in t){this.zoom_behavior.scale(e),this.window_scale=e,this.saved_scale!==null&&(this.saved_scale=e);var n=[t.x,t.y];return this.zoom_behavior.translate(n),this.window_translate=t,this.saved_translate!==null&&(this.saved_translate=n),this.zoomed_sel.transition().attr("transform","translate("+this.window_translate.x+","+this.window_translate.y+")"+"scale("+this.window_scale+")"),null}return console.error("Bad translate value")}function o(e,t,n){var r=80,i={x:{min:-this.window_translate.x/this.window_scale+r/this.window_scale,max:-this.window_translate.x/this.window_scale+(this.width-r)/this.window_scale},y:{min:-this.window_translate.y/this.window_scale+r/this.window_scale,max:-this.window_translate.y/this.window_scale+(this.height-r)/this.window_scale}};t(e.x)<i.x.min?(this.window_translate.x=this.window_translate.x-(t(e.x)-i.x.min)*this.window_scale,this.go_to(this.window_scale,this.window_translate)):t(e.x)>i.x.max&&(this.window_translate.x=this.window_translate.x-(t(e.x)-i.x.max)*this.window_scale,this.go_to(this.window_scale,this.window_translate)),n(e.y)<i.y.min?(this.window_translate.y=this.window_translate.y-(n(e.y)-i.y.min)*this.window_scale,this.go_to(this.window_scale,this.window_translate)):n(e.y)>i.y.max&&(this.window_translate.y=this.window_translate.y-(n(e.y)-i.y.max)*this.window_scale,this.go_to(this.window_scale,this.window_translate))}function u(){this.go_to(1,{x:0,y:0})}var n=e.make_class();return n.prototype={init:r,toggle_zoom:i,go_to:s,translate_off_screen:o,reset:u},n}),n("Input",["utils","lib/complete.ly","Map","ZoomContainer","CallbackManager"],function(e,t,n,r,i){function o(e,s,o){var u=e.append("div").attr("id","rxn-input"),a=t(u.node(),{backgroundColor:"#eee"});d3.select(a.input).on("input",function(){this.value=this.value.replace("/","").replace(" ","").replace("\\","").replace("<","")}),this.selection=u,this.completely=a;var f=this;u.append("button").attr("class","button input-close-button").text("×").on("click",function(){f.hide()}),s instanceof n?(this.map=s,this.setup_map_callbacks()):console.error("Cannot set the map. It is not an instance of builder/Map"),o instanceof r?(this.zoom_container=o,this.setup_zoom_callbacks()):console.error("Cannot set the zoom_container. It is not an instance of builder/ZoomContainer"),this.callback_manager=new i,this.hide()}function u(){var e=this;this.map.callback_manager.set("select_metabolite_with_id.input",function(t,n){e.is_visible&&e.reload(t,n,!1),e.map.sel.selectAll(".start-reaction-target").style("visibility","hidden")}),this.map.callback_manager.set("select_metabolite.input",function(t,n,r){e.map.sel.selectAll(".start-reaction-target").style("visibility","hidden"),t==1&&e.is_visible&&r?e.reload(n,r,!1):e.hide()})}function a(){var e=this;this.zoom_container.callback_manager.set("zoom.input",function(){e.is_visible&&e.place_at_selected()})}function f(){this.toggle(!0)}function l(){this.toggle(!1)}function c(e){e===undefined?this.is_visible=!this.is_visible:this.is_visible=e,this.is_visible?(this.toggle_start_reaction_listener(!0),this.reload_at_selected(),this.map.set_status("Click on the canvas or an existing metabolite"),this.callback_manager.run("show_reaction_input")):(this.toggle_start_reaction_listener(!1),this.selection.style("display","none"),this.completely.input.blur(),this.completely.hideDropDown(),this.map.set_status(null),this.callback_manager.run("hide_reaction_input"))}function h(){this.map.deselect_text_labels();var e=this.map.select_single_node(),t=this.map.scale;if(e==null)return;var n={x:t.x(e.x),y:t.y(e.y)};this.place(n)}function p(e){var t={x:200,y:0},n=this.map.scale,r=this.map.zoom_container.window_translate,i=this.map.zoom_container.window_scale,s=Math.max(20,Math.min(this.map.width-270,i*e.x+r.x-t.x)),o=Math.max(20,Math.min(this.map.height-40,i*e.y+r.y-t.y));this.selection.style("position","absolute").style("display","block").style("left",s+"px").style("top",o+"px")}function d(){this.map.deselect_text_labels();var e=this.map.select_single_node(),t=this.map.scale;if(e==null)return;var n={x:t.x(e.x),y:t.y(e.y)};this.reload(e,n,!1)}function v(t,n,r){function S(e,t){for(var n in t)if(t[n].abbreviation==e)return!0;return!1}function x(e,t,n){return e+": "+n(t)}t===undefined&&!r&&console.error("No selected node, and not starting from scratch");var i=d3.format(".3g");this.place(n),this.completely.input.blur(),this.completely.repaint();if(this.map.cobra_model===null){this.completely.setText("Cannot add: No model.");return}var s=[],o=this.map.cobra_model.reactions,u=this.map.reactions,a=this.map.has_flux(),f=this.map.flux;for(var l in o){var c=o[l];if(S(l,u))continue;for(var h in c.metabolites){var p=c.metabolites[h];if(!r&&t.bigg_id_compartmentalized!=h)continue;if(l in s)continue;var d,v;a?(l in f?d=f[l]*(p.coefficient<1?1:-1):d=0,v=x(l,d,i),s[l]={flux:d,string:v}):s[l]={string:l}}}var m=[],g=e.make_array(s,"reaction_abbreviation");a&&g.sort(function(e,t){return Math.abs(t.flux)-Math.abs(e.flux)}),g.forEach(function(e){m.push(e.string)});var y=20,b=this.completely,w=this,E=this.map.scale;b.options=m,m.length==1?b.setText(m[0]):b.setText(""),b.onEnter=function(){var e=this.getText();this.setText(""),g.map(function(i){if(i.string==e)if(r){var s={x:E.x.invert(n.x),y:E.y.invert(n.y)};w.map.new_reaction_from_scratch(i.reaction_abbreviation,s)}else w.map.new_reaction_for_metabolite(i.reaction_abbreviation,t.node_id)})},b.repaint(),this.completely.input.focus()}function m(e){if(e===undefined)this.start_reaction_listener=!this.start_reaction_listener;else{if(this.start_reaction_listener==e)return;this.start_reaction_listener=e}if(this.start_reaction_listener){var t=this,n=this.map,r=n.scale;n.sel.on("click.start_reaction",function(){console.log("clicked for new reaction");var e={x:r.x(r.x_size.invert(d3.mouse(this)[0])),y:r.y(r.y_size.invert(d3.mouse(this)[1]))};n.deselect_nodes(),n.deselect_text_labels(),t.reload(null,e,!0);var i=n.sel.selectAll(".start-reaction-target").data([12,5]);i.enter().append("circle").classed("start-reaction-target",!0).attr("r",function(e){return r.size(e)}).style("stroke-width",r.size(4)),i.style("visibility","visible").attr("transform","translate("+e.x+","+e.y+")")}),n.sel.classed("start-reaction-cursor",!0)}else this.map.sel.on("click.start_reaction",null),this.map.sel.classed("start-reaction-cursor",!1),this.map.sel.selectAll(".start-reaction-target").style("visibility","hidden")}var s=e.make_class();return s.prototype={init:o,setup_map_callbacks:u,setup_zoom_callbacks:a,show:f,hide:l,toggle:c,place_at_selected:h,place:p,reload_at_selected:d,reload:v,toggle_start_reaction_listener:m},s}),n("CobraModel",["utils"],function(e){function n(e){function i(e){var t=/(.*)_([a-z0-9]{1,2})$/,n=t.exec(e);return n===null?null:n.slice(1,3)}for(var t in e){var n=e[t];n.bigg_id_compartmentalized=t;var r=i(t);r===null&&(r=[t,null]),n.bigg_id=r[0],n.compartment_id=r[1]}}function r(t){t.reactions instanceof Object||t.metabolites instanceof Object||console.error("Bad model data"),this.reactions=e.clone(t.reactions),this.metabolites=e.clone(t.metabolites),this.separate_compartments(this.reactions),this.separate_compartments(this.metabolites),"cofactors"in t?t.cofactors instanceof Array?this.cofactors=t.cofactors:(console.warn("model_data.cofactors should be an array. Ignoring it"),this.cofactors=[]):this.cofactors=[]}var t=e.make_class();return t.separate_compartments=n,t.prototype={init:r},t}),n("Brush",["utils"],function(e){function n(e,t,n,r){this.brush_sel=e.append("g").attr("id","brush-container");var i=this.brush_sel.node(),s=e.select(r).node().nextSibling;i!==s&&i.parentNode.insertBefore(i,s),this.enabled=t,this.map=n}function r(){return d3.select(".brush").empty()}function i(e){e===undefined&&(e=!this.enabled),e?this.selection_brush=this.setup_selection_brush():this.brush_sel.selectAll(".brush").remove()}function s(){var e=this.brush_sel,t=d3.select("#nodes").selectAll(".node"),n=this.map.width,r=this.map.height,i=[],s=this.map.scale;t.each(function(e){i.push(e.node_id)});var o=d3.svg.brush().x(d3.scale.identity().domain([0,n])).y(d3.scale.identity().domain([0,r])).on("brush",function(){var e=d3.event.target.extent();t.classed("selected",function(t){var n=s.x(t.x),r=s.y(t.y);return e[0][0]<=n&&n<e[1][0]&&e[0][1]<=r&&r<e[1][1]})}).on("brushend",function(){d3.event.target.clear(),d3.select(this).call(d3.event.target)}),u=e.append("g").attr("class","brush").call(o);return u}var t=e.make_class();return t.prototype={init:n,toggle:i,setup_selection_brush:s},t}),n("Builder",["utils","Input","ZoomContainer","Map","CobraModel","Brush","CallbackManager"],function(e,t,n,r,i,s,o){function a(t){function i(e,t){e&&console.warn(e),this.o.map_data=t}function s(e,t){e&&console.warn(e),this.o.cobra_model=t}function o(e,t){e&&console.warn(e),this.o.css=t}function u(e,t,n){e&&console.warn(e),n==0?this.o.flux=t:n==1&&(this.o.flux2=t)}function a(e,t){e&&console.warn(e),this.o.node_data=t}var n=e.set_options(t,{margins:{top:5,right:5,bottom:5,left:5},selection:d3.select("body").append("div"),selection_is_svg:!1,fillScreen:!1,enable_editing:!0,on_load:null,map_path:null,map:null,cobra_model_path:null,cobra_model:null,css_path:null,css:null,flux_path:null,flux:null,flux2_path:null,flux2:null,node_data:null,node_data_path:null,node_data_style:"ColorSize",show_beziers:!1,debug:!1,starting_reaction:"GLCtex",reaction_arrow_displacement:35});if(n.selection_is_svg)return console.error("Builder does not support placement within svg elements"),null;this.o=n;var r=[{file:n.map_path,value:n.map,callback:i},{file:n.cobra_model_path,value:n.cobra_model,callback:s},{file:n.css_path,value:n.css,callback:o},{file:n.flux_path,value:n.flux,callback:function(e,t){u.call(this,e,t,0)}},{file:n.flux2_path,value:n.flux2,callback:function(e,t){u.call(this,e,t,1)}},{file:n.node_data_path,value:n.node_data,callback:a}];e.load_files(this,r,f)}function f(){var u=!0,a=!1;this.callback_manager=o();var f=null;this.o.cobra_model!==null?f=i(this.o.cobra_model):console.warn("No cobra model was loaded."),e.remove_child_nodes(this.o.selection);var l=e.setup_svg(this.o.selection,this.o.selection_is_svg,this.o.margins,this.o.fill_screen),c=l.svg,h=l.height,p=l.width,d=e.setup_defs(c,this.o.css);this.zoom_container=new n(c,p,h,[.05,15]);var v=this.zoom_container.zoomed_sel,m=p,g=h,y;this.o.map_data!==null?(this.map=r.from_data(this.o.map_data,v,d,this.zoom_container,h,p,this.o.flux,this.o.node_data,this.o.node_data_style,f),this.zoom_container.reset()):this.map=new r(v,d,this.zoom_container,h,p,this.o.flux,this.o.node_data,this.o.node_data_style,f),this.reaction_input=t(this.o.selection,this.map,this.zoom_container);if(this.o.enable_editing){this.brush=new s(v,!1,this.map,".canvas-group"),this._setup_modes(this.map,this.brush,this.zoom_container);var b=this._get_keys(this.map,this.reaction_input,this.brush);this.map.key_manager.assigned_keys=b;var w=this._setup_menu(this.o.selection,this.map,this.zoom_container,this.map.key_manager,b),E=this._setup_status(this.o.selection,this.map)}this.map.key_manager.reaction_input=this.reaction_input,this.map.key_manager.update();if(this.o.map_data!==null)this.map.draw_everything(),this.map.zoom_extent_canvas();else if(this.o.starting_reaction!==null&&f!==null){var S={x:this.map.scale.x.invert(p/2),y:this.map.scale.x.invert(h/4)};this.map.new_reaction_from_scratch(this.o.starting_reaction,S),this.map.zoom_extent_nodes(300,"nodes")}else this.map.zoom_extent_canvas();this.o.enable_editing?this.zoom_mode():(this.map.behavior.turn_everything_off(),this.map.draw_everything()),d3.select("#loading").style("display","none"),this.o.on_load!==null&&this.o.on_load()}function l(){this.brush.toggle(!0),this.zoom_container.toggle_zoom(!1),this.callback_manager.run("brush_mode")}function c(){this.brush.toggle(!1),this.zoom_container.toggle_zoom(!0),this.callback_manager.run("zoom_mode")}function h(t,n,r,s,o){function l(e,t){e&&console.warn(e),this.o.map_data=t,this.reload_builder()}function c(e,t){e&&console.warn(e);var n=i(t);this.map.set_model(n),this.reaction_input.toggle(!1)}function h(e,t){e&&console.warn(e),this.map.set_flux(t)}function p(e,t){e&&console.warn(e),this.map.set_node_data(t)}function d(e,t,n,r){var i=e.append("button").attr("class","button command-button");return r!==undefined&&i.attr("id",r),v(i,t,n)}function v(e,t,n){return e.text(n).on("click",function(){t.fn.call(t.target)}),e}function m(t,n,r,i){var s=t.append("input").attr("type","file").style("display","none").on("change",function(){e.load_json(this.files[0],n,r)});return t.append("button").attr("class","button command-button").text(i).on("click",function(e){s.node().click()}),function(){s.node().click()}}var u=t.append("div").attr("id","menu");d(u,o.toggle_input,"New reaction (/)"),d(u,o.save,"Save (^s)"),d(u,o.save_svg,"Export SVG (^Shift s)"),s.assigned_keys.load.fn=m(u,l,this,"Load (^o)"),s.assigned_keys.load_model.fn=m(u,c,this,"Load model (^m)"),s.assigned_keys.load_flux.fn=m(u,h,this,"Load reaction data (^f)"),d(u,o.clear_reaction_data,"Clear reaction data"),m(u,p,this,"Load metabolite data"),d(u,o.clear_metabolite_data,"Clear metabolite data");var a=d(u,o.toggle_beziers,"Hide control points (b)","bezier-button");n.callback_manager.set("toggle_beziers.button",function(e){a.text((e?"Hide":"Show")+" control points (b)")});var f=d(u,o.brush_mode,"Enable select (v)","zoom-button");return this.callback_manager.set("zoom_mode",function(){v(f,o.brush_mode,"Enable select (v)")}).set("brush_mode",function(){v(f,o.zoom_mode,"Enable pan+zoom (z)")}),d(u,o.rotate,"Rotate (r)"),d(u,o.delete,"Delete (^del)"),d(u,o.extent_nodes,"Zoom to nodes (^0)"),d(u,o.extent_canvas,"Zoom to canvas (^1)"),d(u,o.make_primary,"Make primary metabolite (p)"),d(u,o.cycle_primary,"Cycle primary metabolite (c)"),d(u,o.direction_arrow_left,"←"),d(u,o.direction_arrow_up,"↑"),d(u,o.direction_arrow_down,"↓"),d(u,o.direction_arrow_right,"→"),d(u,o.undo,"Undo (^z)"),d(u,o.redo,"Redo (^Shift z)"),u}function p(e,t){var n=e.append("div").attr("id","status");return t.callback_manager.set("set_status",function(e){n.text(e)}),n}function d(e,t,n){var r={};e.callback_manager.set("start_rotation",function(){r.brush=t.enabled,t.toggle(!1),r.zoom=n.zoom_on,n.toggle_zoom(!1),r.node_click=e.behavior.node_click!=null,e.behavior.toggle_node_click(!1)}),e.callback_manager.set("end_rotation",function(){t.toggle(r.brush),n.toggle_zoom(r.zoom),e.behavior.toggle_node_click(r.node_click),r={}})}function v(e,t,n){return{toggle_input:{key:191,target:t,fn:t.toggle},save:{key:83,modifiers:{control:!0},target:e,fn:e.save},save_svg:{key:83,modifiers:{control:!0,shift:!0},target:e,fn:e.save_svg},load:{key:79,modifiers:{control:!0},fn:null},load_model:{key:77,modifiers:{control:!0},fn:null},load_flux:{key:70,modifiers:{control:!0},fn:null},clear_reaction_data:{target:e,fn:function(){this.set_flux(null)}},clear_metabolite_data:{target:e,fn:function(){this.set_node_data(null)}},toggle_beziers:{key:66,target:e,fn:e.toggle_beziers,ignore_with_input:!0},zoom_mode:{key:90,target:this,fn:this.zoom_mode,ignore_with_input:!0},brush_mode:{key:86,target:this,fn:this.brush_mode,ignore_with_input:!0},rotate:{key:82,target:e,fn:e.rotate_selected_nodes,ignore_with_input:!0},"delete":{key:8,modifiers:{control:!0},target:e,fn:e.delete_selected,ignore_with_input:!0},delete_del:{key:46,modifiers:{control:!0},target:e,fn:e.delete_selected,ignore_with_input:!0},extent_nodes:{key:48,modifiers:{control:!0},target:e,fn:e.zoom_extent_nodes},extent_canvas:{key:49,modifiers:{control:!0},target:e,fn:e.zoom_extent_canvas},make_primary:{key:80,target:e,fn:e.make_selected_node_primary,ignore_with_input:!0},cycle_primary:{key:67,target:e,fn:e.cycle_primary_node,ignore_with_input:!0},direction_arrow_right:{key:39,target:e.direction_arrow,fn:e.direction_arrow.right,ignore_with_input:!0},direction_arrow_down:{key:40,target:e.direction_arrow,fn:e.direction_arrow.down,ignore_with_input:!0},direction_arrow_left:{key:37,target:e.direction_arrow,fn:e.direction_arrow.left,ignore_with_input:!0},direction_arrow_up:{key:38,target:e.direction_arrow,fn:e.direction_arrow.up,ignore_with_input:!0},undo:{key:90,modifiers:{control:!0},target:e.undo_stack,fn:e.undo_stack.undo},redo:{key:90,modifiers:{control:!0,shift:!0},target:e.undo_stack,fn:e.undo_stack.redo}}}var u=e.make_class();return u.prototype={init:a,reload_builder:f,brush_mode:l,zoom_mode:c,_setup_menu:h,_setup_status:p,_setup_modes:d,_get_keys:v},u}),n("DataMenu",["utils"],function(e){return function(t){function s(e,t,n,r,i){n.node().addEventListener("change",function(){o(e,this.value,i,r)},!1);var s=t[0];u(t,n),o(e,s,i,r)}function o(t,r,i,s){e.load_the_file(t,r,function(e,t){if(e)return console.warn(e);n.data=t,s&&s(t)})}function u(e,t){t.selectAll(".menu-option").data(e).enter().append("option").attr("value",function(e){return e}).text(function(e){return e}),t.node().focus()}function a(){return n.data}var n=e.set_options(t,{selection:d3.select("body"),getdatafiles:null,datafiles:null,update_callback:null,target:null}),r=n.selection.select(".data-menu");r.empty()&&(r=n.selection.append("div").attr("class","data-menu"));var i=r.append("form").append("select").attr("class","dropdown-menu");return n.getdatafiles?(n.datafiles&&console.warn("DataMenu: getdatafiles option overrides datafiles"),d3.json(n.getdatafiles,function(e,t){return e?console.warn(e):(s(n.target,t.data,i,n.update_callback,n.selection),null)})):n.datafiles?s(n.target,n.datafiles,i,n.update_callback,n.selection):console.warn("DataMenu: No datafiles given"),{update:u}}}),n("main",["Builder","Map","Behavior","KeyManager","DataMenu","UndoStack","CobraModel","utils"],function(e,t,n,r,i,s,o,u){return{Builder:e,Map:t,Behavior:n,KeyManager:r,DataMenu:i,UndoStack:s,CobraModel:o,utils:u}}),t("main")});